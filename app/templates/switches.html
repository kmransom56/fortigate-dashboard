<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FortiSwitch Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h1>FortiSwitch Dashboard</h1>
    <div class="container mt-2">
        <div class="row">
            <div class="col-md-6">
                <p id="refresh-timer">Refreshing in 10 seconds...</p>
            </div>
            <div class="col-md-6 text-end">
                <a href="/" class="btn btn-secondary">Home</a>
                <a href="/dashboard" class="btn btn-primary">View FortiGate Dashboard</a>
            </div>
        </div>
    </div>
    
    <div class="container mt-5">
        <h2>Network Map</h2>
        <div id="network" style="height: 400px; border: 1px solid lightgray;"></div>
    </div>

    <div class="container mt-5">
        <h2>FortiSwitches</h2>
        {% for switch in switches %}
        <div class="card mb-4">
            <div class="card-header">
                <h3>{{ switch.name }} ({{ switch.model }})</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Serial:</strong> {{ switch.serial }}</p>
                        <p><strong>Status:</strong> 
                            {% if switch.status == 'online' %}
                                <span class="badge bg-success">Online</span>
                            {% else %}
                                <span class="badge bg-danger">Offline</span>
                            {% endif %}
                        </p>
                        <p><strong>Version:</strong> {{ switch.version }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>IP Address:</strong> {{ switch.ip }}</p>
                        <p><strong>MAC Address:</strong> {{ switch.mac }}</p>
                    </div>
                </div>
                
                <h4 class="mt-4">Connected Devices</h4>
                {% if switch.connected_devices %}
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Port</th>
                            <th>Device Name</th>
                            <th>MAC Address</th>
                            <th>IP Address</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in switch.connected_devices %}
                        <tr>
                            <td>{{ device.port }}</td>
                            <td>{{ device.device_name }}</td>
                            <td>{{ device.device_mac }}</td>
                            <td>{{ device.device_ip }}</td>
                            <td>{{ device.device_type }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No connected devices found.</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
</body>
<script>
    var seconds = 10;
    var countdownElement = document.getElementById('refresh-timer');

    async function fetchNewData() {
        const response = await fetch('/fortigate/api/switches');
        const switches = await response.json();

        updateNetwork(switches);
    }

    function countdown() {
        if (seconds > 0) {
            countdownElement.innerHTML = 'Refreshing in ' + seconds + ' seconds...';
            seconds--;
        } else {
            fetchNewData();
            seconds = 10;  // reset timer
        }
    }
    setInterval(countdown, 1000);

    // vis-network Map
    var container = document.getElementById('network');
    var network = null;

    function updateNetwork(switches) {
        // Build nodes
        var nodes = new vis.DataSet([
            { id: 1, label: 'FortiGate', shape: 'box' }
        ]);

        var edges = [];

        let counter = 2;
        for (const switch_data of switches) {
            nodes.add({
                id: counter,
                label: `${switch_data.name}\n${switch_data.ip}`,
                color: switch_data.status === 'online' ? 'green' : 'red',
                shape: 'triangle'
            });
            edges.push({
                from: 1,
                to: counter
            });
            
            // Add connected devices
            let deviceCounter = counter * 100;
            for (const device of switch_data.connected_devices) {
                nodes.add({
                    id: deviceCounter,
                    label: `${device.device_name}\n${device.device_ip}`,
                    color: 'blue'
                });
                edges.push({
                    from: counter,
                    to: deviceCounter
                });
                deviceCounter++;
            }
            
            counter++;
        }

        // Prepare data
        var data = {
            nodes: nodes,
            edges: edges
        };

        // Configure layout and physics
        var options = {
            nodes: {
                shape: 'dot',
                size: 20
            },
            physics: {
                forceAtlas2Based: {
                    gravitationalConstant: -50,
                    centralGravity: 0.01,
                    springLength: 100
                },
                solver: 'forceAtlas2Based'
            }
        };

        // Initialize network
        if (network) {
            network.setData(data);
        } else {
            network = new vis.Network(container, data, options);
        }
    }

    // Initial fetch
    fetchNewData();
</script>
</html>