<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FortiSwitch Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h1>FortiSwitch Dashboard</h1>
    <div class="container mt-2">
        <div class="row">
            <div class="col-md-6">
                <p id="refresh-timer">Auto-refresh disabled</p>
                <button id="manual-refresh" class="btn btn-primary btn-sm">Refresh Data</button>
            </div>
            <div class="col-md-6 text-end">
                <a href="/" class="btn btn-secondary">Home</a>
                <a href="/dashboard" class="btn btn-primary">View FortiGate Dashboard</a>
            </div>
        </div>
    </div>
    
    <div class="container mt-5">
        <h2>Network Map</h2>
        <div id="network" style="height: 400px; border: 1px solid lightgray;"></div>
    </div>

    <div class="container mt-5">
        <h2>FortiSwitches</h2>
        {% for switch in switches %}
        <div class="card mb-4">
            <div class="card-header">
                <h3>{{ switch.name }} ({{ switch.model }})</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Serial:</strong> {{ switch.serial }}</p>
                        <p><strong>Status:</strong> 
                            {% if switch.status == 'online' %}
                                <span class="badge bg-success">Online</span>
                            {% else %}
                                <span class="badge bg-danger">Offline</span>
                            {% endif %}
                        </p>
                        <p><strong>Version:</strong> {{ switch.version }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>IP Address:</strong> {{ switch.ip }}</p>
                        <p><strong>MAC Address:</strong> {{ switch.mac }}</p>
                        <p><a href="/switches/change-ip/{{ switch.serial }}" class="btn btn-warning btn-sm">
                            <i class="bi bi-pencil"></i> Change IP Address
                        </a></p>
                    </div>
                </div>
                
                <h4 class="mt-4">Connected Devices</h4>
                {% if switch.connected_devices %}
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Port</th>
                            <th>Device Name</th>
                            <th>MAC Address</th>
                            <th>IP Address</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in switch.connected_devices %}
                        <tr>
                            <td>{{ device.port }}</td>
                            <td>{{ device.device_name }}</td>
                            <td>{{ device.device_mac }}</td>
                            <td>{{ device.device_ip }}</td>
                            <td>{{ device.device_type }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No connected devices found.</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
</body>
<script>
    var countdownElement = document.getElementById('refresh-timer');
    var manualRefreshButton = document.getElementById('manual-refresh');

    async function fetchNewData() {
        const response = await fetch('/fortigate/api/switches');
        const switches = await response.json();

        updateNetwork(switches);
        updateSwitchesTable(switches);
    }

    function updateSwitchesTable(switches) {
        // Get the container for switches
        const switchesContainer = document.querySelector('.container.mt-5:last-child');
        
        // Clear existing content except the heading
        const heading = switchesContainer.querySelector('h2');
        switchesContainer.innerHTML = '';
        switchesContainer.appendChild(heading);
        
        // Add each switch
        for (const switch_data of switches) {
            const switchCard = document.createElement('div');
            switchCard.className = 'card mb-4';
            
            // Create card header
            const cardHeader = document.createElement('div');
            cardHeader.className = 'card-header';
            cardHeader.innerHTML = `<h3>${switch_data.name} (${switch_data.model})</h3>`;
            switchCard.appendChild(cardHeader);
            
            // Create card body
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            
            // Add switch info
            const infoRow = document.createElement('div');
            infoRow.className = 'row';
            
            const leftCol = document.createElement('div');
            leftCol.className = 'col-md-6';
            leftCol.innerHTML = `
                <p><strong>Serial:</strong> ${switch_data.serial}</p>
                <p><strong>Status:</strong>
                    ${switch_data.status === 'online'
                        ? '<span class="badge bg-success">Online</span>'
                        : '<span class="badge bg-danger">Offline</span>'}
                </p>
                <p><strong>Version:</strong> ${switch_data.version}</p>
            `;
            
            const rightCol = document.createElement('div');
            rightCol.className = 'col-md-6';
            rightCol.innerHTML = `
                <p><strong>IP Address:</strong> ${switch_data.ip}</p>
                <p><strong>MAC Address:</strong> ${switch_data.mac}</p>
                <p><a href="/switches/change-ip/${switch_data.serial}" class="btn btn-warning btn-sm">
                    <i class="bi bi-pencil"></i> Change IP Address
                </a></p>
            `;
            
            infoRow.appendChild(leftCol);
            infoRow.appendChild(rightCol);
            cardBody.appendChild(infoRow);
            
            // Add connected devices section
            const devicesHeading = document.createElement('h4');
            devicesHeading.className = 'mt-4';
            devicesHeading.textContent = 'Connected Devices';
            cardBody.appendChild(devicesHeading);
            
            if (switch_data.connected_devices && switch_data.connected_devices.length > 0) {
                const table = document.createElement('table');
                table.className = 'table table-striped table-bordered';
                
                // Add table header
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Port</th>
                        <th>Device Name</th>
                        <th>MAC Address</th>
                        <th>IP Address</th>
                        <th>Type</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // Add table body
                const tbody = document.createElement('tbody');
                for (const device of switch_data.connected_devices) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${device.port}</td>
                        <td>${device.device_name}</td>
                        <td>${device.device_mac}</td>
                        <td>${device.device_ip}</td>
                        <td>${device.device_type}</td>
                    `;
                    tbody.appendChild(row);
                }
                table.appendChild(tbody);
                cardBody.appendChild(table);
            } else {
                const noDevices = document.createElement('p');
                noDevices.textContent = 'No connected devices found.';
                cardBody.appendChild(noDevices);
            }
            
            switchCard.appendChild(cardBody);
            switchesContainer.appendChild(switchCard);
        }
    }

    // Add event listener for manual refresh button
    manualRefreshButton.addEventListener('click', function() {
        countdownElement.innerHTML = 'Refreshing...';
        fetchNewData().then(() => {
            countdownElement.innerHTML = 'Auto-refresh disabled';
        });
    });

    // vis-network Map
    var container = document.getElementById('network');
    var network = null;

    function updateNetwork(switches) {
        // Build nodes
        var nodes = new vis.DataSet([
            { id: 1, label: 'FortiGate', shape: 'box' }
        ]);

        var edges = [];

        let counter = 2;
        for (const switch_data of switches) {
            nodes.add({
                id: counter,
                label: `${switch_data.name}\n${switch_data.ip}`,
                color: switch_data.status === 'online' ? 'green' : 'red',
                shape: 'triangle'
            });
            edges.push({
                from: 1,
                to: counter
            });
            
            // Add connected devices
            let deviceCounter = counter * 100;
            for (const device of switch_data.connected_devices) {
                nodes.add({
                    id: deviceCounter,
                    label: `${device.device_name}\n${device.device_ip}`,
                    color: 'blue'
                });
                edges.push({
                    from: counter,
                    to: deviceCounter
                });
                deviceCounter++;
            }
            
            counter++;
        }

        // Prepare data
        var data = {
            nodes: nodes,
            edges: edges
        };

        // Configure layout and physics
        var options = {
            nodes: {
                shape: 'dot',
                size: 20
            },
            physics: {
                forceAtlas2Based: {
                    gravitationalConstant: -50,
                    centralGravity: 0.01,
                    springLength: 100
                },
                solver: 'forceAtlas2Based'
            }
        };

        // Initialize network
        if (network) {
            network.setData(data);
        } else {
            network = new vis.Network(container, data, options);
        }
    }

    // Initial fetch when page loads
    fetchNewData().then(() => {
        countdownElement.innerHTML = 'Auto-refresh disabled';
    });
</script>
</html>