<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FortiSwitch Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h1>FortiSwitch Dashboard</h1>
    <div class="container mt-2">
        <div class="row">
            <div class="col-md-4">
                <p id="refresh-timer">Auto-refresh disabled</p>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="vendor-filter">Filter by Vendor:</label>
                    <select id="vendor-filter" class="form-control">
                        <option value="all">All Vendors</option>
                        <!-- Vendor options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <a href="/" class="btn btn-secondary">Home</a>
                <a href="/dashboard" class="btn btn-primary">View FortiGate Dashboard</a>
                <button id="refresh-vendor-cache" class="btn btn-info">Refresh Vendor Data</button>
            </div>
        </div>
    </div>
    
    <div class="container mt-5">
        <h2>Network Map</h2>
        <div id="network" style="height: 400px; border: 1px solid lightgray;"></div>
    </div>

    <div class="container mt-5">
        <h2>FortiSwitches</h2>
        {% for switch in switches %}
        <div class="card mb-4">
            <div class="card-header">
                <h3>{{ switch.name }} ({{ switch.model }})</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Serial:</strong> {{ switch.serial }}</p>
                        <p><strong>Status:</strong> 
                            {% if switch.status == 'online' %}
                                <span class="badge bg-success">Online</span>
                            {% else %}
                                <span class="badge bg-danger">Offline</span>
                            {% endif %}
                        </p>
                        <p><strong>Version:</strong> {{ switch.version }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>IP Address:</strong> {{ switch.ip }}</p>
                        <p><strong>MAC Address:</strong> {{ switch.mac }}</p>
                        <p><a href="/switches/change-ip/{{ switch.serial }}" class="btn btn-warning btn-sm">
                            <i class="bi bi-pencil"></i> Change IP Address
                        </a></p>
                    </div>
                </div>
                
                <h4 class="mt-4">Connected Devices</h4>
                {% if switch.connected_devices %}
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Port</th>
                            <th>Device Name</th>
                            <th>MAC Address</th>
                            <th>IP Address</th>
                            <th>Type</th>
                            <th>Vendor</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in switch.connected_devices %}
                        <tr class="device-row" data-vendor="{{ device.vendor|default('Unknown') }}">
                            <td>{{ device.port }}</td>
                            <td>{{ device.device_name }}</td>
                            <td>{{ device.device_mac }}</td>
                            <td>{{ device.device_ip }}</td>
                            <td>{{ device.device_type }}</td>
                            <td>
                                <span class="vendor-badge" style="background-color: {{ device.vendor_color|default('#505050') }}">
                                    {{ device.vendor|default('Unknown') }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info lookup-vendor" data-mac="{{ device.device_mac }}">Lookup</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No connected devices found.</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
</body>
<script>
    var countdownElement = document.getElementById('refresh-timer');
    var manualRefreshButton = document.getElementById('manual-refresh');

    async function fetchNewData() {
        const response = await fetch('/fortigate/api/switches');
        const switches = await response.json();

        updateNetwork(switches);
        updateSwitchesTable(switches);
    }

    function updateSwitchesTable(switches) {
        // Get the container for switches
        const switchesContainer = document.querySelector('.container.mt-5:last-child');
        
        // Clear existing content except the heading
        const heading = switchesContainer.querySelector('h2');
        switchesContainer.innerHTML = '';
        switchesContainer.appendChild(heading);
        
        // Add each switch
        for (const switch_data of switches) {
            const switchCard = document.createElement('div');
            switchCard.className = 'card mb-4';
            
            // Create card header
            const cardHeader = document.createElement('div');
            cardHeader.className = 'card-header';
            cardHeader.innerHTML = `<h3>${switch_data.name} (${switch_data.model})</h3>`;
            switchCard.appendChild(cardHeader);
            
            // Create card body
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            
            // Add switch info
            const infoRow = document.createElement('div');
            infoRow.className = 'row';
            
            const leftCol = document.createElement('div');
            leftCol.className = 'col-md-6';
            leftCol.innerHTML = `
                <p><strong>Serial:</strong> ${switch_data.serial}</p>
                <p><strong>Status:</strong>
                    ${switch_data.status === 'online'
                        ? '<span class="badge bg-success">Online</span>'
                        : '<span class="badge bg-danger">Offline</span>'}
                </p>
                <p><strong>Version:</strong> ${switch_data.version}</p>
            `;
            
            const rightCol = document.createElement('div');
            rightCol.className = 'col-md-6';
            rightCol.innerHTML = `
                <p><strong>IP Address:</strong> ${switch_data.ip}</p>
                <p><strong>MAC Address:</strong> ${switch_data.mac}</p>
                <p><a href="/switches/change-ip/${switch_data.serial}" class="btn btn-warning btn-sm">
                    <i class="bi bi-pencil"></i> Change IP Address
                </a></p>
            `;
            
            infoRow.appendChild(leftCol);
            infoRow.appendChild(rightCol);
            cardBody.appendChild(infoRow);
            
            // Add connected devices section
            const devicesHeading = document.createElement('h4');
            devicesHeading.className = 'mt-4';
            devicesHeading.textContent = 'Connected Devices';
            cardBody.appendChild(devicesHeading);
            
            if (switch_data.connected_devices && switch_data.connected_devices.length > 0) {
                const table = document.createElement('table');
                table.className = 'table table-striped table-bordered';
                
                // Add table header
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Port</th>
                        <th>Device Name</th>
                        <th>MAC Address</th>
                        <th>IP Address</th>
                        <th>Type</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // Add table body
                const tbody = document.createElement('tbody');
                for (const device of switch_data.connected_devices) {
                    const row = document.createElement('tr');
                    // Get vendor from MAC address if available
                    let vendorName = '';
                    if (device.device_mac && device.device_mac !== 'Unknown') {
                        // Extract first 8 characters of MAC (including colons)
                        const macPrefix = device.device_mac.substring(0, 8).toUpperCase();
                        vendorName = getVendorFromMacPrefix(macPrefix) || 'Unknown';
                    }
                    
                    row.innerHTML = `
                        <td>${device.port}</td>
                        <td>${device.device_name}</td>
                        <td>${device.device_mac}</td>
                        <td>${device.device_ip}</td>
                        <td>${device.device_type}</td>
                        <td>${vendorName}</td>
                    `;
                    tbody.appendChild(row);
                }
                table.appendChild(tbody);
                cardBody.appendChild(table);
            } else {
                const noDevices = document.createElement('p');
                noDevices.textContent = 'No connected devices found.';
                cardBody.appendChild(noDevices);
            }
            
            switchCard.appendChild(cardBody);
            switchesContainer.appendChild(switchCard);
        }
    }

    // Add event listener for manual refresh button
    manualRefreshButton.addEventListener('click', function() {
        countdownElement.innerHTML = 'Refreshing...';
        fetchNewData().then(() => {
            countdownElement.innerHTML = 'Auto-refresh disabled';
        });
    });

    // vis-network Map
    var container = document.getElementById('network');
    var network = null;

    // Add CSS for vendor badges
    const styleElement = document.createElement('style');
    styleElement.textContent = `
        .vendor-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .device-icon {
            width: 24px;
            height: 24px;
            margin-right: 5px;
            vertical-align: middle;
        }
        .vendor-filter-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .vendor-filter-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .vendor-filter-item:hover {
            background-color: #f0f0f0;
        }
        .vendor-filter-item.active {
            background-color: #e0e0e0;
        }
    `;
    document.head.appendChild(styleElement);
    
    // Function to get vendor from MAC prefix
    function getVendorFromMacPrefix(macPrefix) {
        const vendorMap = {
            // Cisco
            '00:0C:29': 'Cisco',
            '00:40:96': 'Cisco',
            '00:60:09': 'Cisco',
            '00:80:C8': 'Cisco',
            '00:1A:A1': 'Cisco',
            '00:1A:A2': 'Cisco',
            '00:1A:E3': 'Cisco',
            
            // Dell
            '00:14:22': 'Dell',
            '00:1E:C9': 'Dell',
            'F8:BC:12': 'Dell',
            'F8:DB:88': 'Dell',
            
            // HP
            '00:0F:61': 'HP',
            '00:10:83': 'HP',
            '00:17:A4': 'HP',
            '94:57:A5': 'HP',
            '9C:8E:99': 'HP',
            
            // Apple
            '00:03:93': 'Apple',
            '00:05:02': 'Apple',
            '00:0A:27': 'Apple',
            '00:0A:95': 'Apple',
            '00:1E:52': 'Apple',
            '00:25:00': 'Apple',
            '00:26:BB': 'Apple',
            '00:30:65': 'Apple',
            '00:50:E4': 'Apple',
            '00:56:CD': 'Apple',
            
            // Fortinet
            '00:09:0F': 'Fortinet',
            '08:5B:0E': 'Fortinet',
            '00:90:6C': 'Fortinet',
            'E0:23:FF': 'Fortinet',
            
            // Common IoT devices
            'EC:FA:BC': 'IP Camera',
            '00:1A:79': 'Smart Device',
            
            // Samsung
            '00:15:99': 'Samsung',
            '00:17:D5': 'Samsung',
            '00:21:19': 'Samsung',
            '00:23:39': 'Samsung',
            '00:24:54': 'Samsung',
            
            // Printers
            '00:17:C8': 'Printer',
            '00:21:5A': 'Printer',
            '00:26:73': 'Printer',
            
            // IP Phones
            '00:04:F2': 'IP Phone',
            '00:07:0E': 'IP Phone',
            '00:0E:08': 'IP Phone',
            
            // Microsoft/Xbox
            'FC:8C:11': 'Xbox',
            '3C:18:A0': 'Microsoft',
            '0C:37:96': 'Microsoft',
            'D8:43:AE': 'Microsoft',
            
            // Other common vendors
            '38:14:28': 'Huawei',
            '10:7C:61': 'Lenovo',
            'DC:A6:32': 'Raspberry Pi',
            'C4:8B:A3': 'Meraki'
        };
        
        // Try to match the first 8 chars (includes colons)
        if (vendorMap[macPrefix]) {
            return vendorMap[macPrefix];
        }
        
        // Try to match just the first 3 bytes (XX:XX:XX format)
        const firstThreeBytes = macPrefix.substring(0, 8);
        if (vendorMap[firstThreeBytes]) {
            return vendorMap[firstThreeBytes];
        }
        
        return '';
    }
    
    // Base64 encoded SVG icons
    const icons = {
        fortigate: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjRkYwMDAwIiBkPSJNMjU2IDhDMTE5IDggOCAxMTkgOCAyNTZzMTExIDI0OCAyNDggMjQ4IDI0OC0xMTEgMjQ4LTI0OFMzOTMgOCAyNTYgOHptMCA0NDhjLTExMC41IDAtMjAwLTg5LjUtMjAwLTIwMFMxNDUuNSA1NiAyNTYgNTZzMjAwIDg5LjUgMjAwIDIwMC04OS41IDIwMC0yMDAgMjAweiIvPjxwYXRoIGZpbGw9IiNGRjAwMDAiIGQ9Ik0zNjMuNyAxMzQuOWwtMTA3LjcgMTA3LjdMMTQ4LjMgMTM1Yy00LjctNC43LTEyLjMtNC43LTE3IDBsLTIyLjYgMjIuNmMtNC43IDQuNy00LjcgMTIuMyAwIDE3bDEwNy43IDEwNy43LTEwNy43IDEwNy43Yy00LjcgNC43LTQuNyAxMi4zIDAgMTdsMjIuNiAyMi42YzQuNyA0LjcgMTIuMyA0LjcgMTcgMGwxMDcuNy0xMDcuNyAxMDcuNyAxMDcuN2M0LjcgNC43IDEyLjMgNC43IDE3IDBsMjIuNi0yMi42YzQuNy00LjcgNC43LTEyLjMgMC0xN0wyOTUuMyAyODIuM2wxMDcuNy0xMDcuN2M0LjctNC43IDQuNy0xMi4zIDAtMTdsLTIyLjYtMjIuNmMtNC43LTQuNy0xMi4zLTQuNy0xNi43LS4xeiIvPjwvc3ZnPg==',
        fortiswitch: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjMDA3NkNFIiBkPSJNNDQ4IDgwaC0zODRjLTM1LjMgMC02NCAyOC43LTY0IDY0djIyNGMwIDM1LjMgMjguNyA2NCA2NCA2NGgzODRjMzUuMyAwIDY0LTI4LjcgNjQtNjRWMTQ0YzAtMzUuMy0yOC43LTY0LTY0LTY0em0xNiAyODhjMCA4LjgtNy4yIDE2LTE2IDE2aC0zODRjLTguOCAwLTE2LTcuMi0xNi0xNlYxNDRjMC04LjggNy4yLTE2IDE2LTE2aDM4NGM4LjggMCAxNiA3LjIgMTYgMTZ2MjI0eiIvPjxwYXRoIGZpbGw9IiMwMDc2Q0UiIGQ9Ik0xMjggMTQ0Yy0xNy43IDAtMzIgMTQuMy0zMiAzMnYxNjBjMCAxNy43IDE0LjMgMzIgMzIgMzJoMjU2YzE3LjcgMCAzMi0xNC4zIDMyLTMyVjE3NmMwLTE3LjctMTQuMy0zMi0zMi0zMkgxMjh6bTI1NiAxNzZIMTI4VjE3NmgyNTZ2MTQ0eiIvPjwvc3ZnPg==',
        computer: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjMzMzIiBkPSJNNDgwIDQ4SDMyYy0xNy43IDAtMzIgMTQuMy0zMiAzMnYzNTJjMCAxNy43IDE0LjMgMzIgMzIgMzJoOTZ2MTZjMCAxNy43IDE0LjMgMzIgMzIgMzJoMTkyYzE3LjcgMCAzMi0xNC4zIDMyLTMydi0xNmg5NmMxNy43IDAgMzItMTQuMyAzMi0zMlY4MGMwLTE3LjctMTQuMy0zMi0zMi0zMnptLTE0NCA0MTZIMTc2di0xNmgxNjB2MTZ6bTE0NC02NEgzMlY4MGg0NDh2MzIweiIvPjwvc3ZnPg==',
        server: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjNjY2IiBkPSJNNDgwIDEyOGMwLTE3LjctMTQuMy0zMi0zMi0zMkgzMmMtMTcuNyAwLTMyIDE0LjMtMzIgMzJ2NjRjMCAxNy43IDE0LjMgMzIgMzIgMzJoNDE2YzE3LjcgMCAzMi0xNC4zIDMyLTMydi02NHpNNDMyIDE3NkgzMzZjLTguOCAwLTE2LTcuMi0xNi0xNnM3LjItMTYgMTYtMTZoOTZjOC44IDAgMTYgNy4yIDE2IDE2cy03LjIgMTYtMTYgMTZ6bS0yODgtMzJjMC04LjggNy4yLTE2IDE2LTE2czE2IDcuMiAxNiAxNi03LjIgMTYtMTYgMTYtMTYtNy4yLTE2LTE2em00OCAwYzAgOC44LTcuMiAxNi0xNiAxNnMtMTYtNy4yLTE2LTE2IDcuMi0xNiAxNi0xNiAxNiA3LjIgMTYgMTZ6TTQ4MCAzMjBjMC0xNy43LTE0LjMtMzItMzItMzJIMzJjLTE3LjcgMC0zMiAxNC4zLTMyIDMydjY0YzAgMTcuNyAxNC4zIDMyIDMyIDMyaDQxNmMxNy43IDAgMzItMTQuMyAzMi0zMnYtNjR6TTQzMiAzNjhIMzM2Yy04LjggMC0xNi03LjItMTYtMTZzNy4yLTE2IDE2LTE2aDk2YzguOCAwIDE2IDcuMiAxNiAxNnMtNy4yIDE2LTE2IDE2em0tMjg4LTMyYzAtOC44IDcuMi0xNiAxNi0xNnMxNiA3LjIgMTYgMTYtNy4yIDE2LTE2IDE2LTE2LTcuMi0xNi0xNnptNDggMGMwIDguOC03LjIgMTYtMTYgMTZzLTE2LTcuMi0xNi0xNiA3LjItMTYgMTYtMTYgMTYgNy4yIDE2IDE2eiIvPjwvc3ZnPg==',
        xbox: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjMTA3QzEwIiBkPSJNMzY5LjkgMzE4LjJjMjkuNi0yOS42IDYyLjEtNzcuNSA2Mi4xLTExNC44IDAtNDguNi0xNy4zLTc2LjUtMzQuNC05My4xLTMuOS0zLjktMTAuMy0zLjktMTQuMiAwTDMyMCA1MDAuOWM3Ny4xLTI5LjYgOTIuMi0xMDYuMSA0OS45LTE4Mi43ek0yNDAgMzUuNmMtMzUuNCAwLTY0IDI4LjYtNjQgNjRzMjguNiA2NCA2NCA2NCA2NC0yOC42IDY0LTY0LTI4LjYtNjQtNjQtNjR6bS04OS45IDM5NC45TDk2LjggMTEwLjNjLTMuOS0zLjktMTAuMy0zLjktMTQuMiAwLTE3LjIgMTYuNi0zNC40IDQ0LjQtMzQuNCA5My4xIDAgMzcuMyAzMi41IDg1LjIgNjIuMSAxMTQuOC00Mi4zIDc2LjctMjcuMiAxNTMuMiA0OS45IDE4Mi43bC0xMC4xLTEwMC41eiIvPjwvc3ZnPg==',
        generic: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjOTk5IiBkPSJNMjU2IDhDMTE5IDggOCAxMTkgOCAyNTZzMTExIDI0OCAyNDggMjQ4IDI0OC0xMTEgMjQ4LTI0OFMzOTMgOCAyNTYgOHptMCA0NDhjLTExMC41IDAtMjAwLTg5LjUtMjAwLTIwMFMxNDUuNSA1NiAyNTYgNTZzMjAwIDg5LjUgMjAwIDIwMC04OS41IDIwMC0yMDAgMjAweiIvPjwvc3ZnPg=='
    };

    function updateNetwork(switches) {
        // Build nodes
        var nodes = new vis.DataSet([
            { 
                id: 1, 
                label: 'FortiGate', 
                shape: 'image', 
                image: icons.fortigate,
                size: 40,
                font: { size: 14, color: '#ff0000', face: 'Tahoma', strokeWidth: 2, strokeColor: '#ffffff' }
            }
        ]);

        var edges = [];

        let counter = 2;
        for (const switch_data of switches) {
            nodes.add({
                id: counter,
                label: `${switch_data.name}\n${switch_data.ip}`,
                shape: 'image',
                image: icons.fortiswitch,
                size: 35,
                color: { border: switch_data.status === 'online' ? '#00b300' : '#ff0000' },
                font: { size: 14, color: '#0076CE', face: 'Tahoma', strokeWidth: 2, strokeColor: '#ffffff' }
            });
            edges.push({
                from: 1,
                to: counter,
                width: 3,
                color: { color: '#0076CE' },
                arrows: {
                    to: { enabled: true, scaleFactor: 0.5 }
                }
            });
            
            // Add connected devices
            let deviceCounter = counter * 100;
            for (const device of switch_data.connected_devices) {
                // Select icon based on device type
                let deviceIcon = icons.generic;
                let iconColor = '#999';
                
                if (device.device_type.toLowerCase().includes('fortigate')) {
                    deviceIcon = icons.fortigate;
                    iconColor = '#ff0000';
                } else if (device.device_type.toLowerCase().includes('server')) {
                    deviceIcon = icons.server;
                    iconColor = '#666';
                } else if (device.device_type.toLowerCase().includes('xbox')) {
                    deviceIcon = icons.xbox;
                    iconColor = '#107C10';
                } else if (device.device_type.toLowerCase().includes('client') || 
                           device.device_type.toLowerCase().includes('computer') ||
                           device.device_name.toLowerCase().includes('studio')) {
                    deviceIcon = icons.computer;
                    iconColor = '#333';
                }
                
                // Get vendor from MAC address if available
                let vendorInfo = '';
                if (device.device_mac && device.device_mac !== 'Unknown') {
                    // Extract first 8 characters of MAC (including colons)
                    const macPrefix = device.device_mac.substring(0, 8).toUpperCase();
                    
                    // Check against our vendor map
                    const vendor = getVendorFromMacPrefix(macPrefix);
                    if (vendor) {
                        vendorInfo = `[${vendor}]`;
                    }
                }
                
                nodes.add({
                    id: deviceCounter,
                    label: `${device.device_name}${vendorInfo ? '\n' + vendorInfo : ''}\n${device.device_ip}`,
                    shape: 'image',
                    image: deviceIcon,
                    size: 25,
                    font: { size: 12, color: iconColor, face: 'Tahoma', strokeWidth: 2, strokeColor: '#ffffff' }
                });
                edges.push({
                    from: counter,
                    to: deviceCounter,
                    width: 2,
                    color: { color: '#aaaaaa' }
                });
                deviceCounter++;
            }
            
            counter++;
        }

        // Prepare data
        var data = {
            nodes: nodes,
            edges: edges
        };

        // Configure layout and physics
        var options = {
            nodes: {
                borderWidth: 2,
                shadow: true
            },
            edges: {
                smooth: {
                    type: 'continuous'
                },
                shadow: true
            },
            physics: {
                barnesHut: {
                    gravitationalConstant: -2000,
                    centralGravity: 0.3,
                    springLength: 150,
                    springConstant: 0.04,
                    damping: 0.09
                },
                solver: 'barnesHut'
            },
            layout: {
                improvedLayout: true,
                hierarchical: {
                    enabled: false,
                    direction: 'UD',
                    sortMethod: 'directed'
                }
            },
            interaction: {
                navigationButtons: true,
                keyboard: true,
                hover: true
            }
        };

        // Initialize network
        if (network) {
            network.setData(data);
        } else {
            network = new vis.Network(container, data, options);
        }
    }

    // Function to populate vendor filter dropdown
    function populateVendorFilter() {
        const vendorFilter = document.getElementById('vendor-filter');
        if (!vendorFilter) return;
        
        // Clear existing options except the first one
        while (vendorFilter.options.length > 1) {
            vendorFilter.remove(1);
        }
        
        // Get all unique vendors
        const vendors = new Set();
        document.querySelectorAll('.device-row').forEach(row => {
            const vendor = row.getAttribute('data-vendor');
            if (vendor) vendors.add(vendor);
        });
        
        // Add vendor options
        vendors.forEach(vendor => {
            const option = document.createElement('option');
            option.value = vendor;
            option.textContent = vendor;
            vendorFilter.appendChild(option);
        });
        
        // Add event listener
        vendorFilter.addEventListener('change', filterDevicesByVendor);
    }
    
    // Function to filter devices by vendor
    function filterDevicesByVendor() {
        const selectedVendor = document.getElementById('vendor-filter').value;
        const deviceRows = document.querySelectorAll('.device-row');
        
        deviceRows.forEach(row => {
            const vendor = row.getAttribute('data-vendor');
            if (selectedVendor === 'all' || vendor === selectedVendor) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update the network graph to show only the selected vendor
        updateNetworkWithVendorFilter(selectedVendor);
    }
    
    // Function to update the network graph with vendor filter
    function updateNetworkWithVendorFilter(selectedVendor) {
        if (!network) return;
        
        const nodes = network.body.data.nodes;
        const nodeIds = nodes.getIds();
        
        nodeIds.forEach(id => {
            const node = nodes.get(id);
            if (id === 1) return; // Skip the FortiSwitch node
            
            const nodeLabel = node.label || '';
            const vendorMatch = nodeLabel.match(/\[(.*?)\]/); // Extract vendor from [Vendor] in label
            
            if (selectedVendor === 'all') {
                nodes.update({ id: id, hidden: false });
            } else if (vendorMatch && vendorMatch[1] === selectedVendor) {
                nodes.update({ id: id, hidden: false });
            } else if (vendorMatch) {
                nodes.update({ id: id, hidden: true });
            }
        });
    }
    
    // Function to look up vendor online
    function lookupVendorOnline(mac) {
        // Show loading indicator
        const loadingToast = showToast('Looking up vendor information...', 'info');
        
        fetch(`/api/lookup-vendor?mac=${encodeURIComponent(mac)}`)
            .then(response => response.json())
            .then(data => {
                // Hide loading indicator
                hideToast(loadingToast);
                
                if (data.success) {
                    showToast(`Vendor found: ${data.vendor}`, 'success');
                    // Refresh the data to show the updated vendor
                    fetchNewData();
                } else {
                    showToast(`Vendor lookup failed: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                hideToast(loadingToast);
                showToast(`Error: ${error.message}`, 'error');
            });
    }
    
    // Toast notification functions
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-header">
                <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
            <div class="toast-body">${message}</div>
        `;
        
        // Add toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        return toast;
    }
    
    function hideToast(toast) {
        if (toast && toast.parentElement) {
            toast.remove();
        }
    }
    
    // Add event listeners for vendor lookup buttons
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('lookup-vendor')) {
            const mac = event.target.getAttribute('data-mac');
            if (mac) {
                lookupVendorOnline(mac);
            }
        }
    });
    
    // Add event listener for refresh vendor cache button
    document.getElementById('refresh-vendor-cache').addEventListener('click', function() {
        fetch('/api/refresh-vendor-cache')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Vendor cache refreshed successfully', 'success');
                    fetchNewData();
                } else {
                    showToast(`Failed to refresh vendor cache: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showToast(`Error: ${error.message}`, 'error');
            });
    });
    
    // Initial fetch when page loads
    fetchNewData().then(() => {
        countdownElement.innerHTML = 'Auto-refresh disabled';
        // Populate vendor filter after data is loaded
        setTimeout(() => {
            populateVendorFilter();
        }, 500);
    });
</script>
</html>