<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FortiSwitch Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<body>
<div class="container mt-5">
  <h1><i class="fa-solid fa-network-wired"></i> FortiSwitch Dashboard</h1>

  <div class="mt-4 text-end">
    <a href="/" class="btn btn-outline-secondary">Home</a>
    <a href="/dashboard" class="btn btn-primary">View FortiGate Dashboard</a>
  </div>

  <div class="mt-5">
    <h2><i class="fa-solid fa-diagram-project"></i> Network Map</h2>
    <div id="network" style="height: 400px; border: 1px solid lightgray;"></div>
  </div>

  <div class="mt-5">
    <h2><i class="fa-solid fa-server"></i> FortiSwitches</h2>
    <div id="switches-container">
      <!-- Dynamically rendered by JS -->
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    fetchAndUpdateSwitches();
    setInterval(fetchAndUpdateSwitches, 30000); // Auto-refresh every 30s
});

async function fetchAndUpdateSwitches() {
    try {
        const response = await fetch('/fortigate/api/switches');
        const data = await response.json();
        updateSwitchesView(data.switches);
        updateNetwork(data);
    } catch (err) {
        console.error('Error fetching switch data:', err);
    }
}

function updateSwitchesView(switches) {
    const container = document.getElementById('switches-container');
    container.innerHTML = '';

    switches.forEach(sw => {
        let allDevices = [];
        sw.ports?.forEach(port => {
            port.connected_devices?.forEach(dev => {
                allDevices.push({
                    port: port.name,
                    ...dev
                });
            });
        });

        const devicesTable = allDevices.length ? `
            <table class="table table-bordered table-hover mt-3">
              <thead class="table-light">
                <tr>
                  <th>Port</th>
                  <th>Device Name</th>
                  <th>MAC Address</th>
                  <th>IP Address</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                ${allDevices.map(dev => `
                  <tr class="device-row" data-device='${JSON.stringify(dev)}'>
                    <td>${dev.port}</td>
                    <td>
                      ${(dev.icon_path ? `<img src='/static/${dev.icon_path.split('static/')[1]}' alt='${dev.icon_title || "icon"}' style='height:20px;vertical-align:middle;margin-right:4px;'>` : '')}
                      ${dev.device_name || 'Unknown'}
                    </td>
                    <td>${dev.device_mac || 'Unknown'}</td>
                    <td>${dev.device_ip || 'Unknown'}</td>
                    <td>${dev.device_type || 'Unknown'}</td>
                  </tr>`).join('')}
              </tbody>
            </table>` : `<p class="text-muted">No connected devices found.</p>`;

        container.innerHTML += `
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
              <h3><i class="fa-solid fa-microchip"></i> ${sw.name} <small class="text-muted">(${sw.model})</small></h3>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Serial:</strong> ${sw.serial}</p>
                  <p><strong>Status:</strong> ${sw.status === 'online' 
                      ? '<i class="fa-solid fa-circle text-success"></i> Online' 
                      : '<i class="fa-solid fa-circle text-danger"></i> Offline'}
                  </p>
                  <p><strong>Version:</strong> ${sw.version}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>IP Address:</strong> ${sw.ip}</p>
                  <p><strong>MAC Address:</strong> ${sw.mac}</p>
                </div>
              </div>
              ${devicesTable}
              <div id="device-hover-box" class="device-hover-box"></div>
            </div>
          </div>`;
    });
    // Device table hover logic
    const hoverBox = document.getElementById('device-hover-box');
    document.querySelectorAll('.device-row').forEach(row => {
      row.addEventListener('mousemove', e => {
        const device = JSON.parse(row.getAttribute('data-device'));
        let html = `<strong>${device.device_name || 'Unknown'}</strong><br>`;
        html += `<span class='text-muted'>${device.device_type || ''}</span><hr style='margin:0.3em 0;'>`;
        html += `<b>IP:</b> ${device.device_ip || 'N/A'}<br>`;
        html += `<b>MAC:</b> ${device.device_mac || 'N/A'}<br>`;
        html += `<b>Manufacturer:</b> ${device.manufacturer || 'N/A'}<br>`;
        html += `<b>Port:</b> ${device.port || 'N/A'}<br>`;
        html += `<b>VLAN:</b> ${device.vlan || 'N/A'}<br>`;
        html += `<b>DHCP Status:</b> ${device.dhcp_status || 'N/A'}<br>`;
        html += `<b>Last Seen:</b> ${device.last_seen || 'N/A'}<br>`;
        if (device.recommendations) {
          html += `<b>Recommendations:</b><ul>`;
          for (const k in device.recommendations) {
            html += `<li><strong>${k}:</strong> ${device.recommendations[k]}</li>`;
          }
          html += `</ul>`;
        }
        hoverBox.innerHTML = html;
        hoverBox.style.display = 'block';
        hoverBox.style.left = `${e.pageX + 20}px`;
        hoverBox.style.top = `${e.pageY + 10}px`;
        // Scale box width by content
        const contentLength = hoverBox.textContent.length;
        hoverBox.style.width = Math.min(400, Math.max(220, contentLength * 4)) + 'px';
        hoverBox.style.opacity = 1;
      });
      row.addEventListener('mouseleave', () => {
        hoverBox.style.display = 'none';
        hoverBox.style.opacity = 0;
      });
    });
}

function updateNetwork(data) {
    const container = document.getElementById('network');
    if (!container) return;

    const nodes = new vis.DataSet();
    const edges = [];
    const nodeMeta = {};

    // Add cloud nodes for WAN IPs
    let cloudNodeIds = [];
    let nextNodeId = 1;
    if (data.wan_ips && data.wan_ips.length) {
        data.wan_ips.forEach((wan, idx) => {
            const cloudId = nextNodeId++;
            cloudNodeIds.push(cloudId);
            nodes.add({
                id: cloudId,
                label: `Cloud\n${wan.name}: ${wan.ip}`,
                shape: "icon",
                icon: {
                    face: "FontAwesome",
                    code: "\uf0c2", // fa-cloud
                    size: 50,
                    color: "#7f8c8d"
                }
            });
        });
    }

    // FortiGate node
    const fgtNodeId = nextNodeId++;
    nodes.add({
        id: fgtNodeId,
        label: "FortiGate",
        shape: "icon",
        icon: {
            face: "FontAwesome",
            code: "\uf233",  // fa-server
            size: 50,
            color: "#e74c3c"
        }
    });
    // Connect cloud to FortiGate
    cloudNodeIds.forEach(cloudId => {
        edges.push({ from: cloudId, to: fgtNodeId });
    });

    // Switches
    let switchId = nextNodeId;
    data.switches.forEach(sw => {
        const switchNodeId = switchId++;
        nodes.add({
            id: switchNodeId,
            label: `${sw.name}\n${sw.ip}`,
            shape: "icon",
            icon: {
                face: "FontAwesome",
                code: "\uf6ff",  // fa-network-wired
                size: 40,
                color: "#3498db"
            }
        });
        edges.push({ from: fgtNodeId, to: switchNodeId });

        let deviceNodeId = switchNodeId * 100;
        sw.ports?.forEach(port => {
            port.connected_devices?.forEach(dev => {
                const ip = dev.device_ip || "";
                const type = (dev.device_type || "").toLowerCase();
                const label = `${dev.device_name || "Unknown"}\n${ip}`;
                nodes.add({
                    id: deviceNodeId,
                    label: label,
                    shape: "icon",
                    icon: {
                        face: "FontAwesome",
                        code: "\uf108",  // fa-desktop
                        size: 30,
                        color: "#2ecc71"
                    }
                });
                edges.push({ from: switchNodeId, to: deviceNodeId });
                nodeMeta[deviceNodeId] = { ip, type };
                deviceNodeId++;
            });
        });
    });

    const network = new vis.Network(container, { nodes, edges }, {
        nodes: {
            shapeProperties: { useImageSize: true },
            font: { size: 14 }
        },
        edges: { width: 2 },
        physics: true
    });

    network.on("click", function (params) {
        const nodeId = params.nodes[0];
        if (!nodeId || !nodeMeta[nodeId]) return;
        const { ip, type } = nodeMeta[nodeId];
        if (!ip) return alert("No IP address available.");
        const isWindows = type.includes("windows") || type.includes("rdp");
        const uri = isWindows ? `rdp://${ip}` : `ssh://${ip}`;
        window.open(uri, '_blank');
    });
}
</script>
</body>
</html>
