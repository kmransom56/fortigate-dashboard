<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FortiSwitch Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<body>
<div class="container mt-5">
  <h1><i class="fa-solid fa-network-wired"></i> FortiSwitch Dashboard</h1>

  <div class="mt-4 text-end">
    <a href="/" class="btn btn-outline-secondary">Home</a>
    <a href="/dashboard" class="btn btn-primary">View FortiGate Dashboard</a>
  </div>

  <div class="mt-5">
    <div class="row">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-project-diagram"></i> Network Topology</h5>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="fitNetwork()">
                <i class="fas fa-expand-arrows-alt"></i> Fit View
              </button>
              <button class="btn btn-outline-primary" onclick="togglePhysics()">
                <i class="fas fa-play"></i> Physics
              </button>
              <button class="btn btn-outline-primary" onclick="exportTopology()">
                <i class="fas fa-download"></i> Export
              </button>
            </div>
          </div>
          <div class="card-body p-0">
            <div id="network" style="height: 500px; border: 1px solid #dee2e6;"></div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-list"></i> Device Legend</h6>
          </div>
          <div class="card-body">
            <div class="legend-item mb-2 d-flex align-items-center">
              <i class="fa-solid" style="color: #e74c3c; font-size: 18px;">&#xf233;</i>
              <span class="ms-2">FortiGate Firewall</span>
            </div>
            <div class="legend-item mb-2 d-flex align-items-center">
              <i class="fa-solid" style="color: #3498db; font-size: 18px;">&#xf6ff;</i>
              <span class="ms-2">Network Switch</span>
            </div>
            <div class="legend-item mb-2 d-flex align-items-center">
              <i class="fa-solid" style="color: #27ae60; font-size: 16px;">&#xf108;</i>
              <span class="ms-2">Workstation/PC</span>
            </div>
            <div class="legend-item mb-2 d-flex align-items-center">
              <i class="fa-solid" style="color: #9b59b6; font-size: 18px;">&#xf1eb;</i>
              <span class="ms-2">Wireless Access Point</span>
            </div>
            <div class="legend-item mb-2 d-flex align-items-center">
              <i class="fa-solid" style="color: #7f8c8d; font-size: 16px;">&#xf02f;</i>
              <span class="ms-2">Printer</span>
            </div>
            <div class="legend-item mb-2 d-flex align-items-center">
              <i class="fa-solid" style="color: #2c3e50; font-size: 18px;">&#xf233;</i>
              <span class="ms-2">Server</span>
            </div>
            <hr>
            <small class="text-muted">
              <i class="fas fa-info-circle"></i> 
              Hover over devices for details
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-5">
    <h2><i class="fa-solid fa-server"></i> FortiSwitches</h2>
    <div id="switches-container">
      <!-- Dynamically rendered by JS -->
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    fetchAndUpdateSwitches();
    setInterval(fetchAndUpdateSwitches, 30000); // Auto-refresh every 30s
});

async function fetchAndUpdateSwitches() {
    try {
        const response = await fetch('/fortigate/api/switches');
        const switches = await response.json();
        updateSwitchesView(switches);
        updateNetwork(switches);
    } catch (err) {
        console.error('Error fetching switch data:', err);
    }
}

function updateSwitchesView(switches) {
    const container = document.getElementById('switches-container');
    container.innerHTML = '';

    switches.forEach(sw => {
        let allDevices = [];

        sw.ports?.forEach(port => {
            port.connected_devices?.forEach(dev => {
                allDevices.push({
                    port: port.name,
                    ...dev
                });
            });
        });

        const devicesTable = allDevices.length ? `
            <table class="table table-bordered table-hover mt-3">
              <thead class="table-light">
                <tr>
                  <th>Port</th>
                  <th>Device Name</th>
                  <th>MAC Address</th>
                  <th>IP Address</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                ${allDevices.map(dev => `
                  <tr>
                    <td>${dev.port}</td>
                    <td>
                      <i class="fa-solid" style="color: ${dev.icon_color || '#95a5a6'};">&#x${(dev.icon_code || '\uf108').substring(2)};</i>
                      ${dev.device_name || 'Unknown'}
                    </td>
                    <td>${dev.device_mac || 'Unknown'}</td>
                    <td>${dev.device_ip || 'Unknown'}</td>
                    <td>
                      <span class="badge bg-secondary">${dev.restaurant_device_type || dev.device_type || 'Unknown'}</span>
                      ${dev.classification_confidence > 0.5 ? '<i class="fa-solid fa-check-circle text-success ms-1" title="High confidence classification"></i>' : ''}
                    </td>
                  </tr>`).join('')}
              </tbody>
            </table>` : `<p class="text-muted">No connected devices found.</p>`;

        container.innerHTML += `
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
              <h3><i class="fa-solid fa-microchip"></i> ${sw.name} <small class="text-muted">(${sw.model})</small></h3>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Serial:</strong> ${sw.serial}</p>
                  <p><strong>Status:</strong> ${sw.status === 'online' 
                      ? '<i class="fa-solid fa-circle text-success"></i> Online' 
                      : '<i class="fa-solid fa-circle text-danger"></i> Offline'}
                  </p>
                  <p><strong>Version:</strong> ${sw.version}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>IP Address:</strong> ${sw.ip}</p>
                  <p><strong>MAC Address:</strong> ${sw.mac}</p>
                </div>
              </div>
              ${devicesTable}
            </div>
          </div>`;
    });
}

function updateNetwork(switches) {
    const container = document.getElementById('network');
    if (!container) return;

    const nodes = new vis.DataSet();
    const edges = [];
    const nodeMeta = {};

    nodes.add({
        id: 1,
        label: "FortiGate\nMain",
        shape: "icon",
        icon: {
            face: "FontAwesome",
            code: "\uf233",
            size: 50,
            color: "#e74c3c"
        },
        color: {
            border: '#c0392b',
            background: '#ffffff',
            highlight: {
                border: '#a93226',
                background: '#f8f9fa'
            }
        },
        title: `<div style="padding: 10px; font-family: Arial, sans-serif;">
            <strong style="color: #2c3e50;">FortiGate Firewall</strong><br/>
            <span style="color: #27ae60;"><i class="fas fa-circle" style="font-size: 8px;"></i> Online</span><br/>
            <strong>Model:</strong> FortiGate<br/>
            <strong>Status:</strong> Active<br/>
            <strong>Role:</strong> Main Gateway
        </div>`
    });

    let switchId = 2;
    switches.forEach(sw => {
        const switchNodeId = switchId++;
        const deviceCount = sw.ports?.reduce((count, port) => count + (port.connected_devices?.length || 0), 0) || 0;
        
        nodes.add({
            id: switchNodeId,
            label: `${sw.name}\\n(${deviceCount} devices)`,
            shape: "icon",
            icon: {
                face: "FontAwesome",
                code: "\uf6ff",
                size: 40,
                color: "#3498db"
            },
            color: {
                border: '#2980b9',
                background: '#ffffff',
                highlight: {
                    border: '#1f618d',
                    background: '#f8f9fa'
                }
            },
            title: `<div style="padding: 10px; font-family: Arial, sans-serif;">
                <strong style="color: #2c3e50;">${sw.name}</strong><br/>
                <span style="color: #27ae60;"><i class="fas fa-circle" style="font-size: 8px;"></i> Connected</span><br/>
                <strong>IP:</strong> ${sw.ip}<br/>
                <strong>Model:</strong> ${sw.model}<br/>
                <strong>Connected Devices:</strong> ${deviceCount}<br/>
                <strong>Status:</strong> ${sw.status === 'online' ? 'Online' : 'Offline'}
            </div>`
        });
        edges.push({ 
            from: 1, 
            to: switchNodeId,
            color: { color: '#34495e', highlight: '#3498db' },
            width: 3
        });

        let deviceNodeId = switchNodeId * 100;
        sw.ports?.forEach(port => {
            port.connected_devices?.forEach(dev => {
                const ip = dev.device_ip || "";
                const type = (dev.device_type || "").toLowerCase();
                const deviceType = dev.restaurant_device_type || dev.device_type || 'Unknown Device';
                const confidence = dev.classification_confidence || 0;
                const confidenceText = confidence > 0.7 ? 'High' : confidence > 0.4 ? 'Medium' : 'Low';
                const confidenceColor = confidence > 0.7 ? '#27ae60' : confidence > 0.4 ? '#f39c12' : '#e74c3c';
                const label = `${dev.device_name || "Unknown"}\\n${ip}`;
                
                nodes.add({
                    id: deviceNodeId,
                    label: label,
                    shape: "icon",
                    icon: {
                        face: "FontAwesome",
                        code: dev.icon_code || "\uf108",
                        size: dev.icon_size || 30,
                        color: dev.icon_color || "#2ecc71"
                    },
                    color: {
                        border: dev.icon_color || "#2ecc71",
                        background: '#ffffff',
                        highlight: {
                            border: dev.icon_color || "#2ecc71",
                            background: '#f8f9fa'
                        }
                    },
                    title: `<div style="padding: 10px; font-family: Arial, sans-serif;">
                        <strong style="color: #2c3e50;">${dev.device_name || 'Unknown Device'}</strong><br/>
                        <strong>Type:</strong> ${deviceType}<br/>
                        <strong>MAC:</strong> ${dev.device_mac || 'Unknown'}<br/>
                        <strong>IP:</strong> ${ip || 'Unknown'}<br/>
                        <strong>Port:</strong> ${port.name}<br/>
                        <strong>Classification:</strong> <span style="color: ${confidenceColor};">${confidenceText} Confidence</span><br/>
                        ${dev.manufacturer ? `<strong>Manufacturer:</strong> ${dev.manufacturer}<br/>` : ''}
                        ${dev.security_level ? `<strong>Security Level:</strong> ${dev.security_level}` : ''}
                    </div>`
                });
                edges.push({ 
                    from: switchNodeId, 
                    to: deviceNodeId,
                    color: { color: '#7f8c8d', highlight: '#3498db' },
                    width: 2
                });
                nodeMeta[deviceNodeId] = { ip, type };
                deviceNodeId++;
            });
        });
    });

    const network = new vis.Network(container, { nodes, edges }, {
        layout: {
            hierarchical: {
                enabled: true,
                direction: 'UD',
                sortMethod: 'directed',
                levelSeparation: 150,
                nodeSpacing: 200,
                treeSpacing: 200
            }
        },
        physics: {
            enabled: false
        },
        nodes: {
            shape: 'icon',
            size: 40,
            font: {
                size: 12,
                color: '#2c3e50',
                face: 'Arial',
                strokeWidth: 2,
                strokeColor: '#ffffff'
            },
            borderWidth: 2,
            shadow: {
                enabled: true,
                color: 'rgba(0,0,0,0.2)',
                size: 5,
                x: 2,
                y: 2
            }
        },
        edges: {
            width: 2,
            color: {
                color: '#34495e',
                highlight: '#3498db',
                hover: '#3498db'
            },
            smooth: {
                enabled: true,
                type: 'continuous',
                roundness: 0.5
            },
            arrows: {
                to: {
                    enabled: false
                }
            }
        },
        interaction: {
            hover: true,
            selectConnectedEdges: false,
            tooltipDelay: 200,
            zoomView: true,
            dragView: true
        }
    });
    
    window.networkMap = network;
    
    network.on("hoverNode", function (params) {
        document.body.style.cursor = 'pointer';
    });
    
    network.on("blurNode", function (params) {
        document.body.style.cursor = 'default';
    });

    network.on("click", function (params) {
        const nodeId = params.nodes[0];
        if (!nodeId || !nodeMeta[nodeId]) return;
        const { ip, type } = nodeMeta[nodeId];
        if (!ip) return alert("No IP address available.");
        const isWindows = type.includes("windows") || type.includes("rdp");
        const uri = isWindows ? `rdp://${ip}` : `ssh://${ip}`;
        window.open(uri, '_blank');
    });
}

function fitNetwork() {
    if (window.networkMap) {
        window.networkMap.fit({
            animation: {
                duration: 1000,
                easingFunction: 'easeInOutQuad'
            }
        });
    }
}

function togglePhysics() {
    if (window.networkMap) {
        const button = event.target.closest('button');
        const isEnabled = window.networkMap.physics.physicsEnabled;
        
        if (isEnabled) {
            window.networkMap.setOptions({ physics: { enabled: false } });
            button.innerHTML = '<i class="fas fa-play"></i> Physics';
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-primary');
        } else {
            window.networkMap.setOptions({ physics: { enabled: true } });
            button.innerHTML = '<i class="fas fa-pause"></i> Physics';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                window.networkMap.setOptions({ physics: { enabled: false } });
                button.innerHTML = '<i class="fas fa-play"></i> Physics';
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-primary');
            }, 3000);
        }
    }
}

function exportTopology() {
    if (window.networkMap) {
        const canvas = window.networkMap.canvas.frame.canvas;
        const link = document.createElement('a');
        link.download = 'network-topology.png';
        link.href = canvas.toDataURL();
        link.click();
    }
}
</script>
</body>
</html>
