<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FortiSwitch Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<body>
<div class="container mt-5">
  <h1><i class="fa-solid fa-network-wired"></i> FortiSwitch Dashboard</h1>

  <div class="mt-4 text-end">
    <a href="/" class="btn btn-outline-secondary">Home</a>
    <a href="/dashboard" class="btn btn-primary">View FortiGate Dashboard</a>
  </div>

  <div class="mt-5">
    <h2><i class="fa-solid fa-diagram-project"></i> Network Map</h2>
    <div id="network" style="height: 400px; border: 1px solid lightgray;"></div>
  </div>

  <div class="mt-5">
    <h2><i class="fa-solid fa-server"></i> FortiSwitches</h2>
    <div id="switches-container">
      <!-- Dynamically rendered by JS -->
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    fetchAndUpdateSwitches();
    setInterval(fetchAndUpdateSwitches, 30000); // Auto-refresh every 30s
});

async function fetchAndUpdateSwitches() {
    try {
        const response = await fetch('/fortigate/api/switches');
        const switches = await response.json();
        updateSwitchesView(switches);
        updateNetwork(switches);
    } catch (err) {
        console.error('Error fetching switch data:', err);
    }
}

function updateSwitchesView(switches) {
    const container = document.getElementById('switches-container');
    container.innerHTML = '';

    switches.forEach(sw => {
        let allDevices = [];

        sw.ports?.forEach(port => {
            port.connected_devices?.forEach(dev => {
                allDevices.push({
                    port: port.name,
                    ...dev
                });
            });
        });

        const devicesTable = allDevices.length ? `
            <table class="table table-bordered table-hover mt-3">
              <thead class="table-light">
                <tr>
                  <th>Port</th>
                  <th>Device Name</th>
                  <th>MAC Address</th>
                  <th>IP Address</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                ${allDevices.map(dev => `
                  <tr>
                    <td>${dev.port}</td>
                    <td>${dev.device_name || 'Unknown'}</td>
                    <td>${dev.device_mac || 'Unknown'}</td>
                    <td>${dev.device_ip || 'Unknown'}</td>
                    <td>${dev.device_type || 'Unknown'}</td>
                  </tr>`).join('')}
              </tbody>
            </table>` : `<p class="text-muted">No connected devices found.</p>`;

        container.innerHTML += `
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
              <h3><i class="fa-solid fa-microchip"></i> ${sw.name} <small class="text-muted">(${sw.model})</small></h3>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Serial:</strong> ${sw.serial}</p>
                  <p><strong>Status:</strong> ${sw.status === 'online' 
                      ? '<i class="fa-solid fa-circle text-success"></i> Online' 
                      : '<i class="fa-solid fa-circle text-danger"></i> Offline'}
                  </p>
                  <p><strong>Version:</strong> ${sw.version}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>IP Address:</strong> ${sw.ip}</p>
                  <p><strong>MAC Address:</strong> ${sw.mac}</p>
                </div>
              </div>
              ${devicesTable}
            </div>
          </div>`;
    });
}

function updateNetwork(switches) {
    const container = document.getElementById('network');
    if (!container) return;

    const nodes = new vis.DataSet();
    const edges = [];
    const nodeMeta = {};

    nodes.add({
        id: 1,
        label: "FortiGate",
        shape: "icon",
        icon: {
            face: "FontAwesome",
            code: "\uf233",  // fa-server
            size: 50,
            color: "#e74c3c"
        }
    });

    let switchId = 2;
    switches.forEach(sw => {
        const switchNodeId = switchId++;
        nodes.add({
            id: switchNodeId,
            label: `${sw.name}\\n${sw.ip}`,
            shape: "icon",
            icon: {
                face: "FontAwesome",
                code: "\uf6ff",  // fa-network-wired
                size: 40,
                color: "#3498db"
            }
        });
        edges.push({ from: 1, to: switchNodeId });

        let deviceNodeId = switchNodeId * 100;
        sw.ports?.forEach(port => {
            port.connected_devices?.forEach(dev => {
                const ip = dev.device_ip || "";
                const type = (dev.device_type || "").toLowerCase();
                const label = `${dev.device_name || "Unknown"}\\n${ip}`;
                nodes.add({
                    id: deviceNodeId,
                    label: label,
                    shape: "icon",
                    icon: {
                        face: "FontAwesome",
                        code: "\uf108",  // fa-desktop
                        size: 30,
                        color: "#2ecc71"
                    }
                });
                edges.push({ from: switchNodeId, to: deviceNodeId });
                nodeMeta[deviceNodeId] = { ip, type };
                deviceNodeId++;
            });
        });
    });

    const network = new vis.Network(container, { nodes, edges }, {
        nodes: {
            shapeProperties: { useImageSize: true },
            font: { size: 14 }
        },
        edges: { width: 2 },
        physics: true
    });

    network.on("click", function (params) {
        const nodeId = params.nodes[0];
        if (!nodeId || !nodeMeta[nodeId]) return;
        const { ip, type } = nodeMeta[nodeId];
        if (!ip) return alert("No IP address available.");
        const isWindows = type.includes("windows") || type.includes("rdp");
        const uri = isWindows ? `rdp://${ip}` : `ssh://${ip}`;
        window.open(uri, '_blank');
    });
}
</script>
</body>
</html>
