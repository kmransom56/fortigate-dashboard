<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Change FortiSwitch IP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/switches">FortiSwitches</a></li>
                <li class="breadcrumb-item active" aria-current="page">Change IP Address</li>
            </ol>
        </nav>
        
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3>Change IP Address for {{ switch.name }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> <strong>Warning:</strong> Changing the IP address may temporarily disconnect the switch from the network. Make sure you have physical access to the switch in case you need to reset it.
                        </div>
                        
                        <form id="changeIpForm">
                            <input type="hidden" id="switchSerial" value="{{ switch.serial }}">
                            
                            <div class="mb-3">
                                <label for="currentIp" class="form-label">Current IP Address</label>
                                <input type="text" class="form-control" id="currentIp" value="{{ switch.ip }}" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label for="newIp" class="form-label">New IP Address</label>
                                <input type="text" class="form-control" id="newIp" required pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$">
                                <div class="form-text">Format: xxx.xxx.xxx.xxx (e.g., 192.168.1.10)</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="newNetmask" class="form-label">New Netmask</label>
                                <input type="text" class="form-control" id="newNetmask" value="255.255.255.0" required pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$">
                                <div class="form-text">Format: xxx.xxx.xxx.xxx (e.g., 255.255.255.0)</div>
                            </div>
                            
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="confirmCheck" required>
                                <label class="form-check-label" for="confirmCheck">I understand that changing the IP address may cause temporary loss of connectivity.</label>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <a href="/switches" class="btn btn-secondary">Cancel</a>
                                <button type="submit" class="btn btn-primary">Change IP Address</button>
                            </div>
                        </form>
                        
                        <div id="resultAlert" class="alert mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.getElementById('changeIpForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const switchSerial = document.getElementById('switchSerial').value;
            const newIp = document.getElementById('newIp').value;
            const newNetmask = document.getElementById('newNetmask').value;
            const currentIp = document.getElementById('currentIp').value;
            
            // Simple validation
            if (newIp === currentIp) {
                showAlert('danger', 'The new IP address is the same as the current one.');
                return;
            }
            
            // Disable form while processing
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = 'Processing...';
            
            try {
                const response = await fetch('/fortigate/api/switches/change-ip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        switch_serial: switchSerial,
                        new_ip: newIp,
                        new_netmask: newNetmask
                    }),
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', `Success! ${result.message}`);
                    // Redirect after 3 seconds
                    setTimeout(() => {
                        window.location.href = '/switches';
                    }, 3000);
                } else {
                    showAlert('danger', `Error: ${result.detail || 'Unknown error occurred.'}`);
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Change IP Address';
                }
            } catch (error) {
                showAlert('danger', `Error: ${error.message}`);
                submitButton.disabled = false;
                submitButton.innerHTML = 'Change IP Address';
            }
        });
        
        function showAlert(type, message) {
            const alertElement = document.getElementById('resultAlert');
            alertElement.className = `alert mt-3 alert-${type}`;
            alertElement.textContent = message;
            alertElement.style.display = 'block';
        }
    </script>
</body>
</html>