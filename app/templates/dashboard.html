<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FortiGate Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<div class="container mt-5">
    <h2>Network Map</h2>
    <div id="network" style="height: 400px; border: 1px solid lightgray;"></div>
</div>

<body>
<div class="container mt-5">
    <h1>FortiGate Interface Dashboard</h1>
    <div class="container mt-2">
        <div class="row">
            <div class="col-md-6">
                <p id="refresh-timer">Refreshing in 10 seconds...</p>
            </div>
            <div class="col-md-6 text-end">
                <a href="/" class="btn btn-secondary">Home</a>
                <a href="/switches" class="btn btn-success">View FortiSwitch Dashboard</a>
            </div>
        </div>
    </div>
    <div id="wan-alert" class="alert alert-danger" role="alert" style="display:none;">
        ⚠️ WARNING: WAN Link Down Detected!
    </div>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Interface</th>
                <th>IP Address</th>
                <th>Status</th>
                <th>Speed (Mbps)</th>
                <th>TX Bytes</th>
                <th>RX Bytes</th>
            </tr>
        </thead>
        <tbody>
            {% for name, iface in interfaces.items() %}
<tr {% if iface['name'] in ['wan1', 'wan2'] and not iface['link'] %} class="table-danger" {% endif %}>
    <td>{{ iface['name'] }}</td>
    <td>{{ iface['ip'] }}</td>
    <td>
        {% if iface['link'] %}
            <span class="badge bg-success">Up</span>
        {% else %}
            <span class="badge bg-danger">Down</span>
        {% endif %}
    </td>
    <td>{{ iface['speed'] }}</td>
    <td>{{ iface['tx_bytes'] | int }}</td>
    <td>{{ iface['rx_bytes'] | int }}</td>
</tr>
{% endfor %}
    </tbody>
    </table>
    <div class="container mt-5">
        <h2>Interface Traffic (TX Bytes)</h2>
        <canvas id="trafficChart"></canvas>
    </div>
    <div class="container mt-5">
        <h2>Interface Traffic (RX Bytes)</h2>
        <canvas id="rxTrafficChart"></canvas>
    </div>
</div>
</body>
<script>
    var seconds = 300;
    var countdownElement = document.getElementById('refresh-timer');

    async function fetchNewData() {
        const response = await fetch('/fortigate/api/interfaces');
        const interfaces = await response.json();

        updateTable(interfaces);
        updateChart(interfaces);
        updateNetwork(interfaces);
        checkWanAlerts(interfaces); // Check WAN status
    }

    function countdown() {
        if (seconds > 0) {
            countdownElement.innerHTML = 'Refreshing in ' + seconds + ' seconds...';
            seconds--;
        } else {
            fetchNewData();
            seconds = 10;  // reset timer
        }
    }
    setInterval(countdown, 1000);

    function updateTable(interfaces) {
        let tableBody = document.querySelector('tbody');
        tableBody.innerHTML = '';

        for (const [name, iface] of Object.entries(interfaces)) {
            let row = `<tr ${iface.name.startsWith('wan') && !iface.link ? 'class="table-danger"' : ''}>
                <td>${iface.name}</td>
                <td>${iface.ip}</td>
                <td>${iface.link ? '<span class="badge bg-success">Up</span>' : '<span class="badge bg-danger">Down</span>'}</td>
                <td>${iface.speed}</td>
                <td>${iface.tx_bytes}</td>
                <td>${iface.rx_bytes}</td>
            </tr>`;
            tableBody.innerHTML += row;
        }
    }

    // Traffic Chart (TX Bytes)
var ctxTx = document.getElementById('trafficChart').getContext('2d');
var trafficChart = new Chart(ctxTx, {
    type: 'bar',
    data: {
        labels: [],
        datasets: [{
            label: 'TX Bytes',
            data: [],
            backgroundColor: 'rgba(54, 162, 235, 0.7)'
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// NEW: Traffic Chart (RX Bytes)
var ctxRx = document.getElementById('rxTrafficChart').getContext('2d');
var rxTrafficChart = new Chart(ctxRx, {
    type: 'bar',
    data: {
        labels: [],
        datasets: [{
            label: 'RX Bytes',
            data: [],
            backgroundColor: 'rgba(255, 99, 132, 0.7)'
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Update Charts function
function updateChart(interfaces) {
    trafficChart.data.labels = Object.values(interfaces).map(iface => iface.name);
    trafficChart.data.datasets[0].data = Object.values(interfaces).map(iface => iface.tx_bytes);
    trafficChart.update();

    rxTrafficChart.data.labels = Object.values(interfaces).map(iface => iface.name);
    rxTrafficChart.data.datasets[0].data = Object.values(interfaces).map(iface => iface.rx_bytes);
    rxTrafficChart.update();
}



    // vis-network Map
    var container = document.getElementById('network');
var network = null;

// Base64 encoded SVG icons
const icons = {
    fortigate: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjRkYwMDAwIiBkPSJNMjU2IDhDMTE5IDggOCAxMTkgOCAyNTZzMTExIDI0OCAyNDggMjQ4IDI0OC0xMTEgMjQ4LTI0OFMzOTMgOCAyNTYgOHptMCA0NDhjLTExMC41IDAtMjAwLTg5LjUtMjAwLTIwMFMxNDUuNSA1NiAyNTYgNTZzMjAwIDg5LjUgMjAwIDIwMC04OS41IDIwMC0yMDAgMjAweiIvPjxwYXRoIGZpbGw9IiNGRjAwMDAiIGQ9Ik0zNjMuNyAxMzQuOWwtMTA3LjcgMTA3LjdMMTQ4LjMgMTM1Yy00LjctNC43LTEyLjMtNC43LTE3IDBsLTIyLjYgMjIuNmMtNC43IDQuNy00LjcgMTIuMyAwIDE3bDEwNy43IDEwNy43LTEwNy43IDEwNy43Yy00LjcgNC43LTQuNyAxMi4zIDAgMTdsMjIuNiAyMi42YzQuNyA0LjcgMTIuMyA0LjcgMTcgMGwxMDcuNy0xMDcuNyAxMDcuNyAxMDcuN2M0LjcgNC43IDEyLjMgNC43IDE3IDBsMjIuNi0yMi42YzQuNy00LjcgNC43LTEyLjMgMC0xN0wyOTUuMyAyODIuM2wxMDcuNy0xMDcuN2M0LjctNC43IDQuNy0xMi4zIDAtMTdsLTIyLjYtMjIuNmMtNC43LTQuNy0xMi4zLTQuNy0xNi43LS4xeiIvPjwvc3ZnPg==',
    interface: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjMDA3NkNFIiBkPSJNNDY0IDY0SDQ4QzIxLjUgNjQgMCA4NS41IDAgMTEydjI4OGMwIDI2LjUgMjEuNSA0OCA0OCA0OGg0MTZjMjYuNSAwIDQ4LTIxLjUgNDgtNDhWMTEyYzAtMjYuNS0yMS41LTQ4LTQ4LTQ4em0wIDMzNmMwIDguOC03LjIgMTYtMTYgMTZINjRjLTguOCAwLTE2LTcuMi0xNi0xNlYyNDBoMTYwdjY0aDY0di02NGgxOTJ2MTYwem0wLTIyNEg2NHYtNjRjMC04LjggNy4yLTE2IDE2LTE2aDM2OGM4LjggMCAxNiA3LjIgMTYgMTZ2NjR6Ii8+PC9zdmc+',
    wan: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjMDA3NkNFIiBkPSJNMzg3LjkgMzQ3LjJjLTMxLjQtMzEuNC04Mi41LTMxLjQtMTEzLjkgMGwtMjIuNiAyMi42Yy02LjIgNi4yLTE2LjQgNi4yLTIyLjYgMGwtOTEuNS05MS41Yy02LjItNi4yLTYuMi0xNi40IDAtMjIuNmwyMi42LTIyLjZjMzEuNC0zMS40IDMxLjQtODIuNSAwLTExMy45cy04Mi41LTMxLjQtMTEzLjkgMGwtMjIuNiAyMi42Yy02LjIgNi4yLTYuMiAxNi40IDAgMjIuNmwyNzQuNCgyNzQuNGM2LjIgNi4yIDE2LjQgNi4yIDIyLjYgMGwyMi42LTIyLjZjMzEuNC0zMS40IDMxLjQtODIuNSAwLTExMy45ek0xODQuMiA2Ni44YzIwLjUtMjAuNSA1My45LTIwLjUgNzQuNCAwczIwLjUgNTMuOSAwIDc0LjRsLTIyLjYgMjIuNmMtNi4yIDYuMi02LjIgMTYuNCAwIDIyLjZsOTEuNSA5MS41YzYuMiA2LjIgMTYuNCA2LjIgMjIuNiAwbDIyLjYtMjIuNmMyMC41LTIwLjUgNTMuOS0yMC41IDc0LjQgMHMyMC41IDUzLjkgMCA3NC40bC0yMi42IDIyLjZjLTYuMiA2LjItNi4yIDE2LjQgMCAyMi42bDIyLjYgMjIuNmM2LjIgNi4yIDE2LjQgNi4yIDIyLjYgMGw0NS4zLTQ1LjNjNTAuMy01MC4zIDUwLjMtMTMxLjcgMC0xODItMzEuNC0zMS40LTcyLjEtNDIuOS0xMTEuNC0zNC41IDkuNy00NS4xLTEuNy05My43LTM0LjUtMTI2LjUtNTAuMy01MC4zLTEzMS43LTUwLjMtMTgyIDBsLTQ1LjMgNDUuM2MtNi4yIDYuMi02LjIgMTYuNCAwIDIyLjZsMjIuNiAyMi42YzYuMiA2LjIgMTYuNCA2LjIgMjIuNiAwbDQ1LjMtNDUuMnoiLz48L3N2Zz4=',
    lan: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjMDA3NkNFIiBkPSJNNDg4IDY0aC04Yy0xMy4yNSAwLTI0IDEwLjc0LTI0IDI0djEzMmgtNDhWOTZjMC0yNi41MS0yMS40OS00OC00OC00OEgxNTJjLTI2LjUxIDAtNDggMjEuNDktNDggNDh2MTI4SDU2VjgwYzAtNC40Mi0zLjU4LTgtOC04aC04Yy0xMy4yNSAwLTI0IDEwLjc0LTI0IDI0djIwOGMwIDEzLjI1IDEwLjc1IDI0IDI0IDI0aDhjNC40MiAwIDgtMy41OCA4LThoNDh2MTI4YzAgMjYuNTEgMjEuNDkgNDggNDggNDhoMjA4YzI2LjUxIDAgNDgtMjEuNDkgNDgtNDhWMzI4aDQ4YzQuNDIgMCA4LTMuNTggOC04di04YzAtMTMuMjYtMTAuNzUtMjQtMjQtMjRoLThjLTQuNDIgMC04IDMuNTgtOCA4djEzMmgtNDhWOTZjMC04LjgyIDcuMTgtMTYgMTYtMTZoMjA4YzguODIgMCAxNiA3LjE4IDE2IDE2djEyOGgtNDhWODhjMC0xMy4yNi0xMC43NS0yNC0yNC0yNHptLTMzNiA4MGMwLTguODIgNy4xOC0xNiAxNi0xNmg2NGM4LjgyIDAgMTYgNy4xOCAxNiAxNnY0OGMwIDguODIgLTcuMTggMTYtMTYgMTZoLTY0Yy04LjgyIDAtMTYtNy4xOC0xNi0xNnYtNDh6bTEyOCAxNzZjMCA4LjgyLTcuMTggMTYtMTYgMTZoLTY0Yy04LjgyIDAtMTYtNy4xOC0xNi0xNnYtNDhjMC04LjgyIDcuMTggLTE2IDE2LTE2aDY0YzguODIgMCAxNiA3LjE4IDE2IDE2djQ4em0xNDQtMTc2YzAgOC44Mi03LjE4IDE2LTE2IDE2aC02NGMtOC44MiAwLTE2LTcuMTgtMTYtMTZ2LTQ4YzAtOC44MiA3LjE4LTE2IDE2LTE2aDY0YzguODIgMCAxNiA3LjE4IDE2IDE2djQ4em0tMTQ0IDBjMCA4LjgyLTcuMTggMTYtMTYgMTZoLTY0Yy04LjgyIDAtMTYtNy4xOC0xNi0xNnYtNDhjMC04LjgyIDcuMTgtMTYgMTYtMTZoNjRjOC44MiAwIDE2IDcuMTggMTYgMTZ2NDh6Ii8+PC9zdmc+'
};

function updateNetwork(interfaces) {
    // Build nodes
    var nodes = new vis.DataSet([
        { 
            id: 1, 
            label: 'FortiGate', 
            shape: 'image', 
            image: icons.fortigate,
            size: 40,
            font: { size: 14, color: '#ff0000', face: 'Tahoma', strokeWidth: 2, strokeColor: '#ffffff' }
        }
    ]);

    var edges = [];

    let counter = 2;
    for (const [name, iface] of Object.entries(interfaces)) {
        // Select appropriate icon based on interface name
        let interfaceIcon = icons.interface;
        let iconColor = '#0076CE';
        
        if (iface.name.toLowerCase().includes('wan')) {
            interfaceIcon = icons.wan;
        } else if (iface.name.toLowerCase().includes('lan') || 
                   iface.name.toLowerCase().includes('port') || 
                   iface.name.toLowerCase().includes('internal')) {
            interfaceIcon = icons.lan;
        }
        
        nodes.add({
            id: counter,
            label: `${iface.name}\n${iface.ip}`,
            shape: 'image',
            image: interfaceIcon,
            size: 30,
            color: { border: iface.link ? '#00b300' : '#ff0000' },
            font: { size: 14, color: iconColor, face: 'Tahoma', strokeWidth: 2, strokeColor: '#ffffff' }
        });
        edges.push({
            from: 1,
            to: counter,
            width: 3,
            color: { color: iface.link ? '#00b300' : '#ff0000' },
            arrows: {
                to: { enabled: true, scaleFactor: 0.5 }
            }
        });
        counter++;
    }

    // Prepare data
    var data = {
        nodes: nodes,
        edges: edges
    };

    // Configure layout and physics
    var options = {
        nodes: {
            borderWidth: 2,
            shadow: true
        },
        edges: {
            smooth: {
                type: 'continuous'
            },
            shadow: true
        },
        physics: {
            barnesHut: {
                gravitationalConstant: -2000,
                centralGravity: 0.3,
                springLength: 150,
                springConstant: 0.04,
                damping: 0.09
            },
            solver: 'barnesHut'
        },
        layout: {
            improvedLayout: true,
            hierarchical: {
                enabled: false,
                direction: 'UD',
                sortMethod: 'directed'
            }
        },
        interaction: {
            navigationButtons: true,
            keyboard: true,
            hover: true
        }
    };

    // Initialize network
    if (network) {
        network.setData(data);
    } else {
        network = new vis.Network(container, data, options);
    }
    
}

// Function to check WAN status and show alerts
function checkWanAlerts(interfaces) {
    const wan1 = interfaces['wan1'];
    const wan2 = interfaces['wan2'];

    const alertBox = document.getElementById('wan-alert');

    if ((wan1 && !wan1.link) || (wan2 && !wan2.link)) {
        alertBox.style.display = 'block';  // Show alert
    } else {
        alertBox.style.display = 'none';   // Hide alert
    }
}
</script>

</html>
