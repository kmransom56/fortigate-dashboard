<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FortiGate Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<body>
<div class="container mt-5">
  <div class="mb-4 text-center">
    <a href="/dashboard.html" class="d-inline-block text-decoration-none">
      <img src="https://cdn-icons-png.flaticon.com/512/565/565547.png" alt="Firewall" style="height:60px;width:60px;object-fit:contain;vertical-align:middle;">
      <span class="fw-bold ms-2" style="font-size:1.3rem;vertical-align:middle;">View Fortigate</span>
    </a>
  </div>
  <style>
    .device-hover-box {
      position: absolute;
      z-index: 9999;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      padding: 1rem;
      min-width: 220px;
      max-width: 400px;
      font-size: 0.95rem;
      pointer-events: none;
      display: none;
      transition: opacity 0.2s;
    }
    .device-hover-box ul {
      padding-left: 1.2em;
      margin-bottom: 0;
    }
    .device-hover-box strong {
      color: #2980b9;
    }
  </style>
    </a>
  </div>
  <h1 class="mb-3"><i class="fa-solid fa-chart-line"></i> FortiGate Dashboard</h1>

  <div class="mt-5">
    <h2><i class="fa-solid fa-diagram-project"></i> Hierarchical Network Map</h2>
    <div id="network" style="height: 500px; border: 1px solid lightgray; background: #f8fafc; border-radius: 8px;"></div>
    <div class="text-center mt-2">
      <span class="badge bg-info">Cloud Connection: <span id="cloud-status">Checking...</span></span>
    </div>
  </div>

  <div class="table-responsive mt-5">
    <h3 class="mb-3"><i class="fa-solid fa-desktop"></i> Connected Devices (All Switches)</h3>
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th>Device Name</th>
          <th>Type</th>
          <th>IP Address</th>
          <th>MAC Address</th>
          <th>Manufacturer</th>
          <th>Switch</th>
          <th>Port</th>
          <th>VLAN</th>
          <th>DHCP Status</th>
          <th>Last Seen</th>
          <th>Recommendations</th>
        </tr>
      </thead>
      <tbody>
        {% for dev in device_details %}
        <tr class="device-row" data-device='{{ dev | tojson | safe }}'>
          <td>
            {% if dev.icon_path %}
              <img src="{{ url_for('static', filename=dev.icon_path.split('static/')[1]) }}" alt="{{ dev.icon_title or 'icon' }}" style="height:24px;width:24px;vertical-align:middle;margin-right:4px;">
            {% endif %}
            {{ dev.device_name }}
          </td>
          <td>{{ dev.device_type }}</td>
          <td>{{ dev.device_ip }}</td>
          <td>{{ dev.device_mac }}</td>
          <td>{{ dev.manufacturer }}</td>
          <td>{{ dev.switch_name }}</td>
          <td>{{ dev.port_name }}</td>
          <td>{{ dev.vlan }}</td>
          <td>{{ dev.dhcp_status }}</td>
          <td>{{ dev.last_seen }}</td>
          <td>
            {% if dev.recommendations %}
              <ul class="mb-0">
                {% for k, v in dev.recommendations.items() %}
                  <li><strong>{{ k }}:</strong> {{ v }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <span class="text-muted">N/A</span>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="11">No device details available.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="mt-4">
    <a href="/" class="btn btn-outline-primary"><i class="fa-solid fa-arrow-left"></i> Back to Home</a>
  </div>
</div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const interfacesData = {{ interfaces | tojson }};
      fetch('/api/cloud_status')
        .then(res => res.json())
        .then(data => {
          document.getElementById('cloud-status').textContent = data.status;
          updateNetwork(interfacesData, data.status);
        })
        .catch(() => {
          document.getElementById('cloud-status').textContent = 'Unavailable';
          updateNetwork(interfacesData, 'Unavailable');
        });

      // Device table hover logic
      const hoverBox = document.createElement('div');
      hoverBox.className = 'device-hover-box';
      document.body.appendChild(hoverBox);

      function showHoverBox(device, x, y) {
        let html = `<strong>${device.device_name || 'Unknown'}</strong><br>`;
        html += `<span class='text-muted'>${device.device_type || ''}</span><hr style='margin:0.3em 0;'>`;
        html += `<b>IP:</b> ${device.device_ip || 'N/A'}<br>`;
        html += `<b>MAC:</b> ${device.device_mac || 'N/A'}<br>`;
        html += `<b>Manufacturer:</b> ${device.manufacturer || 'N/A'}<br>`;
        html += `<b>Switch:</b> ${device.switch_name || 'N/A'}<br>`;
        html += `<b>Port:</b> ${device.port_name || 'N/A'}<br>`;
        html += `<b>VLAN:</b> ${device.vlan || 'N/A'}<br>`;
        html += `<b>DHCP Status:</b> ${device.dhcp_status || 'N/A'}<br>`;
        html += `<b>Last Seen:</b> ${device.last_seen || 'N/A'}<br>`;
        if (device.recommendations) {
          html += `<b>Recommendations:</b><ul>`;
          for (const k in device.recommendations) {
            html += `<li><strong>${k}:</strong> ${device.recommendations[k]}</li>`;
          }
          html += `</ul>`;
        }
        hoverBox.innerHTML = html;
        hoverBox.style.display = 'block';
        hoverBox.style.left = `${x + 20}px`;
        hoverBox.style.top = `${y + 10}px`;
        // Scale box width by content
        const contentLength = hoverBox.textContent.length;
        hoverBox.style.width = Math.min(400, Math.max(220, contentLength * 4)) + 'px';
        hoverBox.style.opacity = 1;
      }

      function hideHoverBox() {
        hoverBox.style.display = 'none';
        hoverBox.style.opacity = 0;
      }

      document.querySelectorAll('.device-row').forEach(row => {
        row.addEventListener('mousemove', e => {
          const device = JSON.parse(row.getAttribute('data-device'));
          showHoverBox(device, e.pageX, e.pageY);
        });
        row.addEventListener('mouseleave', hideHoverBox);
      });
    });

    function updateNetwork(interfaces, cloudStatus) {
      const container = document.getElementById('network');
      if (!container) return;

      const nodes = new vis.DataSet();
      const edges = [];
      const nodeMeta = {};

      // Cloud node
      nodes.add({
        id: 'cloud',
        label: 'Cloud',
        shape: 'icon',
        icon: {
          face: 'FontAwesome',
          code: '\uf0c2', // fa-cloud
          size: 60,
          color: cloudStatus === 'Connected' ? '#27ae60' : '#b2bec3'
        }
      });
      // FortiGate node
      nodes.add({
        id: 'fortigate',
        label: 'FortiGate',
        shape: 'icon',
        icon: {
          face: 'FontAwesome',
          code: '\uf233', // fa-server
          size: 50,
          color: '#e74c3c'
        }
      });
      edges.push({ from: 'cloud', to: 'fortigate' });

      // FortiSwitch node
      nodes.add({
        id: 'fortiswitch',
        label: 'FortiSwitch',
        shape: 'icon',
        icon: {
          face: 'FontAwesome',
          code: '\uf6ff', // fa-network-wired
          size: 40,
          color: '#2980b9'
        }
      });
      edges.push({ from: 'fortigate', to: 'fortiswitch' });

      // Device nodes
      let deviceId = 1;
      for (const key in interfaces) {
        if (interfaces.hasOwnProperty(key)) {
          const iface = interfaces[key];
          const devNodeId = 'dev' + deviceId++;
          nodes.add({
            id: devNodeId,
            label: `${iface.name}\n${iface.ip || 'No IP'}`,
            shape: 'icon',
            icon: {
              face: 'FontAwesome',
              code: '\uf109', // fa-desktop
              size: 30,
              color: '#16a085'
            }
          });
          edges.push({ from: 'fortiswitch', to: devNodeId });
          nodeMeta[devNodeId] = { ip: iface.ip, name: iface.name };
        }
      }

      const network = new vis.Network(container, { nodes, edges }, {
        nodes: {
          shapeProperties: { useImageSize: true },
          font: { size: 14 }
        },
        edges: { width: 2 },
        layout: { hierarchical: { direction: 'UD', sortMethod: 'directed' } },
        physics: false
      });

      network.on('click', function (params) {
        const nodeId = params.nodes[0];
        if (!nodeId || !nodeMeta[nodeId]) return;
        const { ip, name } = nodeMeta[nodeId];
        if (ip) {
          alert(`Device: ${name}\nIP: ${ip}`);
        } else {
          alert(`Device: ${name}\nNo IP address available.`);
        }
      });
    }
  </script>
</body>
</html>
