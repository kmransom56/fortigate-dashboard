<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FortiGate Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<div class="container mt-5">
    <h2>Network Map</h2>
    <div id="network" style="height: 400px; border: 1px solid lightgray;"></div>
</div>

<body>
<div class="container mt-5">
    <h1>FortiGate Interface Dashboard</h1>
    <div class="container mt-2">
        <div class="row">
            <div class="col-md-6">
                <p id="refresh-timer">Refreshing in 10 seconds...</p>
            </div>
            <div class="col-md-6 text-end">
                <a href="/" class="btn btn-secondary">Home</a>
                <a href="/switches" class="btn btn-success">View FortiSwitch Dashboard</a>
            </div>
        </div>
    </div>
    <div id="wan-alert" class="alert alert-danger" role="alert" style="display:none;">
        ⚠️ WARNING: WAN Link Down Detected!
    </div>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Interface</th>
                <th>IP Address</th>
                <th>Status</th>
                <th>Speed (Mbps)</th>
                <th>TX Bytes</th>
                <th>RX Bytes</th>
            </tr>
        </thead>
        <tbody>
            {% for name, iface in interfaces.items() %}
<tr {% if iface['name'] in ['wan1', 'wan2'] and not iface['link'] %} class="table-danger" {% endif %}>
    <td>{{ iface['name'] }}</td>
    <td>{{ iface['ip'] }}</td>
    <td>
        {% if iface['link'] %}
            <span class="badge bg-success">Up</span>
        {% else %}
            <span class="badge bg-danger">Down</span>
        {% endif %}
    </td>
    <td>{{ iface['speed'] }}</td>
    <td>{{ iface['tx_bytes'] | int }}</td>
    <td>{{ iface['rx_bytes'] | int }}</td>
</tr>
{% endfor %}
    </tbody>
    </table>
    <div class="container mt-5">
        <h2>Interface Traffic (TX Bytes)</h2>
        <canvas id="trafficChart"></canvas>
    </div>
    <div class="container mt-5">
        <h2>Interface Traffic (RX Bytes)</h2>
        <canvas id="rxTrafficChart"></canvas>
    </div>
</div>
</body>
<script>
    var seconds = 300;
    var countdownElement = document.getElementById('refresh-timer');

    async function fetchNewData() {
        const response = await fetch('/fortigate/api/interfaces');
        const interfaces = await response.json();

        updateTable(interfaces);
        updateChart(interfaces);
        updateNetwork(interfaces);
        checkWanAlerts(interfaces); // Check WAN status
    }

    function countdown() {
        if (seconds > 0) {
            countdownElement.innerHTML = 'Refreshing in ' + seconds + ' seconds...';
            seconds--;
        } else {
            fetchNewData();
            seconds = 10;  // reset timer
        }
    }
    setInterval(countdown, 1000);

    function updateTable(interfaces) {
        let tableBody = document.querySelector('tbody');
        tableBody.innerHTML = '';

        for (const [name, iface] of Object.entries(interfaces)) {
            let row = `<tr ${iface.name.startsWith('wan') && !iface.link ? 'class="table-danger"' : ''}>
                <td>${iface.name}</td>
                <td>${iface.ip}</td>
                <td>${iface.link ? '<span class="badge bg-success">Up</span>' : '<span class="badge bg-danger">Down</span>'}</td>
                <td>${iface.speed}</td>
                <td>${iface.tx_bytes}</td>
                <td>${iface.rx_bytes}</td>
            </tr>`;
            tableBody.innerHTML += row;
        }
    }

    // Traffic Chart (TX Bytes)
var ctxTx = document.getElementById('trafficChart').getContext('2d');
var trafficChart = new Chart(ctxTx, {
    type: 'bar',
    data: {
        labels: [],
        datasets: [{
            label: 'TX Bytes',
            data: [],
            backgroundColor: 'rgba(54, 162, 235, 0.7)'
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// NEW: Traffic Chart (RX Bytes)
var ctxRx = document.getElementById('rxTrafficChart').getContext('2d');
var rxTrafficChart = new Chart(ctxRx, {
    type: 'bar',
    data: {
        labels: [],
        datasets: [{
            label: 'RX Bytes',
            data: [],
            backgroundColor: 'rgba(255, 99, 132, 0.7)'
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Update Charts function
function updateChart(interfaces) {
    trafficChart.data.labels = Object.values(interfaces).map(iface => iface.name);
    trafficChart.data.datasets[0].data = Object.values(interfaces).map(iface => iface.tx_bytes);
    trafficChart.update();

    rxTrafficChart.data.labels = Object.values(interfaces).map(iface => iface.name);
    rxTrafficChart.data.datasets[0].data = Object.values(interfaces).map(iface => iface.rx_bytes);
    rxTrafficChart.update();
}



    // vis-network Map
    var container = document.getElementById('network');
var network = null;

function updateNetwork(interfaces) {
    // Build nodes
    var nodes = new vis.DataSet([
        { id: 1, label: 'FortiGate', shape: 'box' }
    ]);

    var edges = [];

    let counter = 2;
    for (const [name, iface] of Object.entries(interfaces)) {
        nodes.add({
            id: counter,
            label: `${iface.name}\n${iface.ip}`,
            color: iface.link ? 'green' : 'red'
        });
        edges.push({
            from: 1,
            to: counter
        });
        counter++;
    }

    // Prepare data
    var data = {
        nodes: nodes,
        edges: edges
    };

    // Configure layout and physics
    var options = {
        nodes: {
            shape: 'dot',
            size: 20
        },
        physics: {
            forceAtlas2Based: {
                gravitationalConstant: -80,
                centralGravity: 0.05,
                springLength: 200,
                springConstant: 0.05,
                damping: 0.4
            },
            solver: 'forceAtlas2Based'
        },
        layout: {
            improvedLayout: true
        }
    };

    // Initialize network
    if (network) {
        network.setData(data);
    } else {
        network = new vis.Network(container, data, options);
    }
    
}

// Function to check WAN status and show alerts
function checkWanAlerts(interfaces) {
    const wan1 = interfaces['wan1'];
    const wan2 = interfaces['wan2'];

    const alertBox = document.getElementById('wan-alert');

    if ((wan1 && !wan1.link) || (wan2 && !wan2.link)) {
        alertBox.style.display = 'block';  // Show alert
    } else {
        alertBox.style.display = 'none';   // Hide alert
    }
}
</script>

</html>
