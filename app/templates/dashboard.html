<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FortiGate Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<body>
<div class="container mt-5">
  <div class="mb-4 text-center">
    <a href="/dashboard.html" class="d-inline-block text-decoration-none">
      <img src="https://cdn-icons-png.flaticon.com/512/565/565547.png" alt="Firewall" style="height:60px;width:60px;object-fit:contain;vertical-align:middle;">
      <span class="fw-bold ms-2" style="font-size:1.3rem;vertical-align:middle;">View Fortigate</span>
    </a>
  </div>
  <style>
    .device-hover-box {
      position: absolute;
      z-index: 9999;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      padding: 1rem;
      min-width: 220px;
      max-width: 400px;
      font-size: 0.95rem;
      pointer-events: none;
      display: none;
      transition: opacity 0.2s;
    }
    .device-hover-box ul {
      padding-left: 1.2em;
      margin-bottom: 0;
    }
    .device-hover-box strong {
      color: #2980b9;
    }
  </style>
    </a>
  </div>
  <h1 class="mb-3"><i class="fa-solid fa-chart-line"></i> FortiGate Dashboard</h1>

  <div class="mt-5">
    <h2><i class="fa-solid fa-diagram-project"></i> Hierarchical Network Map</h2>
    <div id="network" style="height: 500px; border: 1px solid lightgray; background: #f8fafc; border-radius: 8px;"></div>
    <div class="text-center mt-2">
      <span class="badge bg-info">Cloud Connection: <span id="cloud-status">Checking...</span></span>
    </div>
  </div>

  <div class="table-responsive mt-5">
    <h3 class="mb-3"><i class="fa-solid fa-desktop"></i> Connected Devices (All Switches)</h3>
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th>Device Name</th>
          <th>Type</th>
          <th>IP Address</th>
          <th>MAC Address</th>
          <th>Manufacturer</th>
          <th>Switch</th>
          <th>Port</th>
          <th>VLAN</th>
          <th>DHCP Status</th>
          <th>Last Seen</th>
          <th>Recommendations</th>
        </tr>
      </thead>
      <tbody>
        {% for dev in device_details %}
        <tr class="device-row" data-device='{{ dev | tojson | safe }}'>
          <td>
            {% if dev.icon_path %}
              <img src="{{ url_for('static', filename=dev.icon_path.split('static/')[1]) }}" alt="{{ dev.icon_title or 'icon' }}" style="height:24px;width:24px;vertical-align:middle;margin-right:4px;">
            {% endif %}
            {{ dev.device_name }}
          </td>
          <td>{{ dev.device_type }}</td>
          <td>{{ dev.device_ip }}</td>
          <td>{{ dev.device_mac }}</td>
          <td>{{ dev.manufacturer }}</td>
          <td>{{ dev.switch_name }}</td>
          <td>{{ dev.port_name }}</td>
          <td>{{ dev.vlan }}</td>
          <td>{{ dev.dhcp_status }}</td>
          <td>{{ dev.last_seen }}</td>
          <td>
            {% if dev.recommendations %}
              <ul class="mb-0">
                {% for k, v in dev.recommendations.items() %}
                  <li><strong>{{ k }}:</strong> {{ v }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <span class="text-muted">N/A</span>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="11">No device details available.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="mt-4">
    <a href="/" class="btn btn-outline-primary"><i class="fa-solid fa-arrow-left"></i> Back to Home</a>
  </div>
</div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      fetchAndUpdateDashboard();
    });

    async function fetchAndUpdateDashboard() {
      try {
        const response = await fetch('/fortigate/api/switches');
        const data = await response.json();
        updateNetwork(data);
      } catch (err) {
        document.getElementById('cloud-status').textContent = 'Unavailable';
      }
    }

    function updateNetwork(data) {
      const container = document.getElementById('network');
      if (!container) return;

      const nodes = new vis.DataSet();
      const edges = [];
      const nodeMeta = {};

      // Add cloud nodes for WAN IPs
      let cloudNodeIds = [];
      let nextNodeId = 1;
      if (data.wan_ips && data.wan_ips.length) {
        data.wan_ips.forEach((wan, idx) => {
          const cloudId = nextNodeId++;
          cloudNodeIds.push(cloudId);
          nodes.add({
            id: cloudId,
            label: `Cloud\n${wan.name}: ${wan.ip}`,
            shape: "icon",
            icon: {
              face: "FontAwesome",
              code: "\uf0c2", // fa-cloud
              size: 50,
              color: "#7f8c8d"
            }
          });
        });
      }

      // FortiGate node
      const fgtNodeId = nextNodeId++;
      nodes.add({
        id: fgtNodeId,
        label: "FortiGate",
        shape: "icon",
        icon: {
          face: "FontAwesome",
          code: "\uf233",  // fa-server
          size: 50,
          color: "#e74c3c"
        }
      });
      // Connect cloud to FortiGate
      cloudNodeIds.forEach(cloudId => {
        edges.push({ from: cloudId, to: fgtNodeId });
      });

      // Switches
      let switchId = nextNodeId;
      data.switches.forEach(sw => {
        const switchNodeId = switchId++;
        nodes.add({
          id: switchNodeId,
          label: `${sw.name}\n${sw.ip}`,
          shape: "icon",
          icon: {
            face: "FontAwesome",
            code: "\uf6ff",  // fa-network-wired
            size: 40,
            color: "#3498db"
          }
        });
        edges.push({ from: fgtNodeId, to: switchNodeId });

        let deviceNodeId = switchNodeId * 100;
        sw.ports?.forEach(port => {
          port.connected_devices?.forEach(dev => {
            const ip = dev.device_ip || "";
            const type = (dev.device_type || "").toLowerCase();
            const label = `${dev.device_name || "Unknown"}\n${ip}`;
            nodes.add({
              id: deviceNodeId,
              label: label,
              shape: "icon",
              icon: {
                face: "FontAwesome",
                code: "\uf108",  // fa-desktop
                size: 30,
                color: "#2ecc71"
              }
            });
            edges.push({ from: switchNodeId, to: deviceNodeId });
            nodeMeta[deviceNodeId] = { ip, type };
            deviceNodeId++;
          });
        });
      });

      const network = new vis.Network(container, { nodes, edges }, {
        nodes: {
          shapeProperties: { useImageSize: true },
          font: { size: 14 }
        },
        edges: { width: 2 },
        physics: true
      });

      network.on("click", function (params) {
        const nodeId = params.nodes[0];
        if (!nodeId || !nodeMeta[nodeId]) return;
        const { ip, type } = nodeMeta[nodeId];
        if (!ip) return alert("No IP address available.");
        const isWindows = type.includes("windows") || type.includes("rdp");
        const uri = isWindows ? `rdp://${ip}` : `ssh://${ip}`;
        window.open(uri, '_blank');
      });
    }
  </script>
</body>
</html>
