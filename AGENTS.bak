# AGENTS.md

This file provides instructions for AI agents (like Claude Code) when working with this codebase.

## Code Quality Checks - MANDATORY After Every Rewrite

**IMPORTANT**: After every code rewrite, modification, or file edit, you MUST run the following code quality checks in this exact order:

### 1. Format Code with Black

```bash
# Using uv (preferred on Linux)
uv run black app/ tests/ tools/ *.py

# Or using Python directly
python -m black app/ tests/ tools/ *.py

# Or if using virtual environment
source .venv/bin/activate  # Linux
# or
.venv\Scripts\activate  # Windows
black app/ tests/ tools/ *.py
```

**Configuration**: Black uses `pyproject.toml` settings (line length: 88, target Python version: 3.12+)

### 2. Lint Code with Flake8

```bash
# Using uv (preferred on Linux)
uv run flake8 app/ tests/ tools/ --max-line-length=88 --ignore=E203,W503,E501

# Or using Python directly
python -m flake8 app/ tests/ tools/ --max-line-length=88 --ignore=E203,W503,E501

# Or if using virtual environment
flake8 app/ tests/ tools/ --max-line-length=88 --ignore=E203,W503,E501
```

**Configuration**: Flake8 uses `.flake8` config file with max-line-length=88 and ignores E203, W503, E501

### 3. Compile Python Files (Syntax Check)

```bash
# Using uv (preferred on Linux)
uv run python -m py_compile app/**/*.py tests/**/*.py tools/**/*.py

# Or using Python directly
python -m py_compile app/**/*.py tests/**/*.py tools/**/*.py

# Or compile all Python files recursively
find app tests tools -name "*.py" -exec python -m py_compile {} \;
```

**Note**: This checks for Python syntax errors. If any files fail to compile, fix the syntax errors before proceeding.

### Complete Quality Check Script

For convenience, run all checks in sequence:

```bash
# Linux/Mac
echo "Running code quality checks..."
uv run black app/ tests/ tools/ *.py && \
uv run flake8 app/ tests/ tools/ --max-line-length=88 --ignore=E203,W503,E501 && \
find app tests tools -name "*.py" -exec python -m py_compile {} \; && \
echo "✅ All code quality checks passed!"

# Windows (PowerShell)
Write-Host "Running code quality checks..."
uv run black app/ tests/ tools/ *.py
if ($LASTEXITCODE -ne 0) { exit 1 }
uv run flake8 app/ tests/ tools/ --max-line-length=88 --ignore=E203,W503,E501
if ($LASTEXITCODE -ne 0) { exit 1 }
Get-ChildItem -Path app,tests,tools -Recurse -Filter *.py | ForEach-Object { python -m py_compile $_.FullName }
if ($LASTEXITCODE -ne 0) { exit 1 }
Write-Host "✅ All code quality checks passed!"
```

## Docker Container Management - MANDATORY When Working with Containers

**IMPORTANT**: When making changes to code that runs in Docker containers, you MUST stop and delete containers to ensure all changes are applied.

### Stop and Remove All Containers

```bash
# Stop all running containers for this project
docker compose down

# Stop and remove containers, networks, and volumes (use with caution)
docker compose down -v

# Stop specific compose file
docker compose -f docker-compose.dev.yml down
docker compose -f docker-compose.prod.yml down
docker compose -f docker-compose.enterprise.yml down
```

### Remove Containers and Images

```bash
# Remove containers, networks, volumes, and images
docker compose down --rmi all -v

# Or manually remove containers
docker ps -a | grep fortigate | awk '{print $1}' | xargs docker rm -f

# Remove images
docker images | grep fortigate | awk '{print $3}' | xargs docker rmi -f
```

### Rebuild After Changes

After stopping and removing containers, rebuild to apply changes:

```bash
# Rebuild and start (development)
docker compose -f docker-compose.dev.yml up --build -d

# Rebuild and start (production)
docker compose -f docker-compose.prod.yml up --build -d

# Rebuild and start (enterprise)
docker compose -f docker-compose.enterprise.yml up --build -d

# Rebuild without cache (ensures fresh build)
docker compose up --build --no-cache -d
```

### Complete Docker Workflow

When working with Docker containers:

1. **Stop and remove containers**:
   ```bash
   docker compose down
   ```

2. **Make code changes** (edit files, add features, fix bugs)

3. **Run code quality checks** (see section above):
   ```bash
   uv run black app/ tests/ tools/ *.py
   uv run flake8 app/ tests/ tools/ --max-line-length=88 --ignore=E203,W503,E501
   find app tests tools -name "*.py" -exec python -m py_compile {} \;
   ```

4. **Rebuild containers**:
   ```bash
   docker compose up --build -d
   ```

5. **Verify changes**:
   ```bash
   docker compose logs -f fortigate-dashboard
   ```

## Workflow Summary

### Standard Development Workflow

1. Make code changes
2. **Run code quality checks** (black, flake8, pycompile)
3. Fix any issues found
4. If using Docker: **Stop and remove containers**
5. If using Docker: **Rebuild containers**
6. Test changes
7. Commit changes

### Docker-Specific Workflow

1. **Stop containers**: `docker compose down`
2. Make code changes
3. **Run code quality checks**: black → flake8 → pycompile
4. Fix any issues
5. **Rebuild**: `docker compose up --build -d`
6. **Verify**: `docker compose logs -f fortigate-dashboard`
7. Test functionality
8. Commit changes

## Configuration Files

### Black Configuration (`pyproject.toml`)

```toml
[tool.black]
line-length = 88
target-version = ['py312', 'py313']
include = '\.pyi?$'
extend-exclude = '''
/(
  # directories
  \.eggs
  | \.git
  | \.hg
  | \.mypy_cache
  | \.tox
  | \.venv
  | venv
  | _build
  | buck-out
  | build
  | dist
  | __pycache__
)/
'''
```

### Flake8 Configuration (`.flake8`)

```ini
[flake8]
max-line-length = 88
extend-ignore = E203, W503, E501
exclude =
    .git,
    __pycache__,
    .venv,
    venv,
    build,
    dist,
    *.egg-info,
    .mypy_cache,
    .pytest_cache
per-file-ignores =
    __init__.py:F401
```

## Troubleshooting

### Black Issues

- **Import errors**: Ensure black is installed: `uv pip install black` or `pip install black`
- **File not found**: Check file paths and ensure you're in the project root
- **Permission errors**: Check file permissions

### Flake8 Issues

- **Too many errors**: Run black first to auto-format code
- **Import errors**: Ensure flake8 is installed: `uv pip install flake8` or `pip install flake8`
- **Configuration not found**: Ensure `.flake8` file exists in project root

### PyCompile Issues

- **Syntax errors**: Fix syntax errors before proceeding
- **Import errors**: These are expected during compilation check - only syntax matters
- **File encoding**: Ensure files use UTF-8 encoding

### Docker Issues

- **Containers won't stop**: Use `docker compose down --remove-orphans`
- **Port conflicts**: Check if ports are already in use: `netstat -tulpn | grep <port>`
- **Build cache issues**: Use `--no-cache` flag: `docker compose build --no-cache`
- **Volume conflicts**: Remove volumes: `docker compose down -v`

## Integration with CI/CD

These checks should also be integrated into CI/CD pipelines:

```yaml
# Example GitHub Actions workflow
- name: Code Quality Checks
  run: |
    uv run black --check app/ tests/ tools/ *.py
    uv run flake8 app/ tests/ tools/ --max-line-length=88 --ignore=E203,W503,E501
    find app tests tools -name "*.py" -exec python -m py_compile {} \;
```

## Notes

- **Always run checks in order**: black → flake8 → pycompile
- **Fix issues immediately**: Don't proceed with broken code
- **Docker changes require rebuild**: Code changes won't apply to running containers
- **Use uv on Linux**: Prefer `uv run` for package execution on Linux systems
- **Virtual environments**: Activate venv before running checks if not using uv
