#!/bin/bash
# LTM Network Intelligence Platform - Quick Setup Script
# This script automates the initial setup and deployment

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
LTM_PLATFORM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
DOCKER_COMPOSE_FILE="$LTM_PLATFORM_DIR/docker-compose.yml"
ENV_FILE="$LTM_PLATFORM_DIR/.env"
VENV_DIR="$LTM_PLATFORM_DIR/ltm-venv"

# Functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

check_requirements() {
    log_info "Checking system requirements..."
    
    # Check Python version
    if command -v python3 &> /dev/null; then
        PYTHON_VERSION=$(python3 --version 2>&1 | cut -d' ' -f2 | cut -d'.' -f1,2)
        REQUIRED_VERSION="3.8"
        if [ "$(printf '%s\n' "$REQUIRED_VERSION" "$PYTHON_VERSION" | sort -V | head -n1)" = "$REQUIRED_VERSION" ]; then
            log_success "Python $PYTHON_VERSION found"
        else
            log_error "Python 3.8+ required, found $PYTHON_VERSION"
            exit 1
        fi
    else
        log_error "Python 3 not found. Please install Python 3.8 or higher."
        exit 1
    fi
    
    # Check if running on supported OS
    OS="$(uname -s)"
    case "${OS}" in
        Linux*)     MACHINE=Linux;;
        Darwin*)    MACHINE=Mac;;
        *)          MACHINE="UNKNOWN:${OS}"
    esac
    log_info "Running on $MACHINE"
    
    # Check available disk space (minimum 10GB)
    AVAILABLE_SPACE=$(df "$LTM_PLATFORM_DIR" | tail -1 | awk '{print $4}')
    REQUIRED_SPACE=10485760  # 10GB in KB
    if [ "$AVAILABLE_SPACE" -lt "$REQUIRED_SPACE" ]; then
        log_warning "Low disk space. Recommended: 10GB+, Available: $(($AVAILABLE_SPACE/1048576))GB"
    else
        log_success "Sufficient disk space available"
    fi
    
    # Check RAM (minimum 4GB)
    if [ "$MACHINE" = "Linux" ]; then
        TOTAL_RAM=$(free -k | grep MemTotal | awk '{print $2}')
        REQUIRED_RAM=4194304  # 4GB in KB
        if [ "$TOTAL_RAM" -lt "$REQUIRED_RAM" ]; then
            log_warning "Low RAM. Recommended: 4GB+, Available: $(($TOTAL_RAM/1048576))GB"
        else
            log_success "Sufficient RAM available"
        fi
    fi
}

detect_setup_method() {
    log_info "Detecting optimal setup method..."
    
    if command -v docker &> /dev/null && command -v docker-compose &> /dev/null; then
        log_success "Docker and Docker Compose found - using containerized setup"
        SETUP_METHOD="docker"
    elif command -v python3 &> /dev/null && command -v pip3 &> /dev/null; then
        log_success "Python and pip found - using native setup"
        SETUP_METHOD="native"
    else
        log_error "Neither Docker nor Python/pip found. Please install one of:"
        echo "  1. Docker and Docker Compose for containerized setup"
        echo "  2. Python 3.8+ and pip for native setup"
        exit 1
    fi
}

create_env_file() {
    log_info "Creating environment configuration..."
    
    cat > "$ENV_FILE" << EOF
# LTM Network Intelligence Platform Environment Configuration
# Generated by quick setup script on $(date)

# Platform Configuration
ENVIRONMENT=development
LTM_PLATFORM_VERSION=2.0.0

# LTM Server Configuration
LTM_SERVER_URL=http://localhost:8000
LTM_LEARNING_ENABLED=true

# Database Configuration
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=ltm_neo4j_$(openssl rand -hex 8)

MILVUS_HOST=localhost
MILVUS_PORT=19530

REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=ltm_redis_$(openssl rand -hex 8)

# PostgreSQL Configuration
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=ltm_user
POSTGRES_PASSWORD=ltm_postgres_$(openssl rand -hex 8)
POSTGRES_DB=ltm_audit

# API Gateway Configuration
API_GATEWAY_PORT=8002
JWT_SECRET=$(openssl rand -base64 32)

# Security Configuration
ENCRYPTION_ENABLED=true
AUDIT_LOGGING_ENABLED=true

# Monitoring Configuration
PROMETHEUS_PORT=9090
GRAFANA_PORT=3000
GRAFANA_PASSWORD=ltm_grafana_$(openssl rand -hex 8)

# Device API Keys (set these to your actual keys)
FORTIGATE_API_KEY=your_fortigate_api_key_here
MERAKI_API_KEY=your_meraki_api_key_here
FORTIMANAGER_IP=your_fortimanager_ip_here
FORTIMANAGER_USERNAME=your_fortimanager_username_here
FORTIMANAGER_PASSWORD=your_fortimanager_password_here

# Optional: Repository Integration Paths
NETAI_TROUBLESHOOTER_PATH=../netai-troubleshooter
MCP_SERVER_PATH=../network-device-mcp-server
FORTIGATE_PLATFORM_PATH=../FortiGate-Enterprise-Platform
AI_RESEARCH_PATH=../ai-research-platform
NETWORK_UTILS_PATH=../network_device_utils
EOF
    
    log_success "Environment file created at $ENV_FILE"
    log_warning "Please update the API keys in $ENV_FILE with your actual credentials"
}

setup_docker() {
    log_info "Setting up LTM Platform with Docker..."
    
    # Check Docker daemon
    if ! docker info > /dev/null 2>&1; then
        log_error "Docker daemon is not running. Please start Docker and try again."
        exit 1
    fi
    
    # Create necessary directories
    log_info "Creating directory structure..."
    mkdir -p "$LTM_PLATFORM_DIR"/{config,logs,data,security,backups,monitoring/grafana/dashboards}
    
    # Create monitoring configuration
    create_monitoring_config
    
    # Pull images and start services
    log_info "Pulling Docker images and starting services..."
    cd "$LTM_PLATFORM_DIR"
    
    # Create docker network
    docker network create ltm-network 2>/dev/null || true
    
    # Start infrastructure services first
    docker-compose up -d neo4j redis postgres etcd minio
    
    log_info "Waiting for infrastructure services to be ready..."
    sleep 30
    
    # Start Milvus
    docker-compose up -d milvus
    sleep 15
    
    # Start monitoring (optional)
    docker-compose up -d prometheus grafana
    
    # Finally start the main platform
    docker-compose up -d ltm-platform
    
    log_success "Docker setup completed"
}

setup_native() {
    log_info "Setting up LTM Platform natively..."
    
    # Create virtual environment
    log_info "Creating Python virtual environment..."
    python3 -m venv "$VENV_DIR"
    source "$VENV_DIR/bin/activate"
    
    # Upgrade pip
    pip install --upgrade pip
    
    # Install requirements
    log_info "Installing Python dependencies..."
    cd "$LTM_PLATFORM_DIR"
    pip install -r requirements.txt
    
    # Create directory structure
    log_info "Creating directory structure..."
    mkdir -p {config,logs,data,security,backups,monitoring}
    
    # Initialize platform
    log_info "Initializing LTM platform..."
    python unified_network_intelligence.py --initialize --components ltm,mcp,security,performance
    
    log_success "Native setup completed"
    log_info "To activate the virtual environment in the future, run:"
    log_info "source $VENV_DIR/bin/activate"
}

create_monitoring_config() {
    log_info "Creating monitoring configuration..."
    
    # Prometheus configuration
    cat > "$LTM_PLATFORM_DIR/monitoring/prometheus.yml" << EOF
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'ltm-platform'
    static_configs:
      - targets: ['ltm-platform:8003']
    scrape_interval: 10s
    metrics_path: /metrics

  - job_name: 'milvus'
    static_configs:
      - targets: ['milvus:9091']
    
  - job_name: 'neo4j'
    static_configs:
      - targets: ['neo4j:2004']
EOF

    # Grafana dashboards directory
    mkdir -p "$LTM_PLATFORM_DIR/monitoring/grafana/provisioning/dashboards"
    mkdir -p "$LTM_PLATFORM_DIR/monitoring/grafana/provisioning/datasources"
    
    # Grafana datasource configuration
    cat > "$LTM_PLATFORM_DIR/monitoring/grafana/provisioning/datasources/prometheus.yml" << EOF
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
EOF

    # Basic dashboard configuration
    cat > "$LTM_PLATFORM_DIR/monitoring/grafana/provisioning/dashboards/dashboard.yml" << EOF
apiVersion: 1

providers:
  - name: 'default'
    orgId: 1
    folder: ''
    type: file
    disableDeletion: false
    editable: true
    options:
      path: /var/lib/grafana/dashboards
EOF
}

create_startup_scripts() {
    log_info "Creating startup scripts..."
    
    # Docker startup script
    cat > "$LTM_PLATFORM_DIR/start_platform_docker.sh" << 'EOF'
#!/bin/bash
# Start LTM Platform with Docker

set -e

LTM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$LTM_DIR"

echo "Starting LTM Network Intelligence Platform with Docker..."

# Check if .env file exists
if [ ! -f .env ]; then
    echo "Error: .env file not found. Run quick_setup.sh first."
    exit 1
fi

# Start all services
docker-compose up -d

echo "Platform started successfully!"
echo ""
echo "Services available at:"
echo "  - LTM Platform: http://localhost:8000"
echo "  - API Gateway: http://localhost:8002"
echo "  - API Documentation: http://localhost:8002/api/docs"
echo "  - Prometheus: http://localhost:9090"
echo "  - Grafana: http://localhost:3000"
echo "  - Neo4j Browser: http://localhost:7474"
echo ""
echo "To view logs: docker-compose logs -f ltm-platform"
echo "To stop: docker-compose down"
EOF

    # Native startup script
    cat > "$LTM_PLATFORM_DIR/start_platform_native.sh" << 'EOF'
#!/bin/bash
# Start LTM Platform natively

set -e

LTM_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$LTM_DIR"

echo "Starting LTM Network Intelligence Platform natively..."

# Activate virtual environment if it exists
if [ -d "ltm-venv" ]; then
    source ltm-venv/bin/activate
    echo "Virtual environment activated"
fi

# Check if platform is initialized
if [ ! -f "config/platform_initialized" ]; then
    echo "Initializing platform..."
    python unified_network_intelligence.py --initialize
    touch config/platform_initialized
fi

# Start the platform
echo "Starting platform..."
python unified_network_intelligence.py

echo "Platform started successfully!"
EOF

    chmod +x "$LTM_PLATFORM_DIR/start_platform_docker.sh"
    chmod +x "$LTM_PLATFORM_DIR/start_platform_native.sh"
}

create_postgres_init() {
    log_info "Creating PostgreSQL initialization script..."
    
    cat > "$LTM_PLATFORM_DIR/scripts/init_postgres.sql" << 'EOF'
-- PostgreSQL initialization script for LTM Platform

-- Create database and user (if not exists)
CREATE DATABASE ltm_audit;
CREATE USER ltm_user WITH PASSWORD 'ltm_password';
GRANT ALL PRIVILEGES ON DATABASE ltm_audit TO ltm_user;

-- Connect to the ltm_audit database
\c ltm_audit;

-- Grant schema privileges
GRANT ALL ON SCHEMA public TO ltm_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO ltm_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO ltm_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO ltm_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO ltm_user;

-- Create initial tables
CREATE TABLE IF NOT EXISTS security_events (
    event_id VARCHAR(100) PRIMARY KEY,
    event_type VARCHAR(50) NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    user_id VARCHAR(100),
    session_id VARCHAR(100),
    source_ip INET,
    resource_accessed TEXT,
    action_attempted TEXT NOT NULL,
    success BOOLEAN NOT NULL,
    risk_level VARCHAR(20) NOT NULL,
    details JSONB,
    compliance_tags VARCHAR(50)[],
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS compliance_violations (
    violation_id VARCHAR(100) PRIMARY KEY,
    rule_id VARCHAR(100) NOT NULL,
    standard VARCHAR(50) NOT NULL,
    severity VARCHAR(20) NOT NULL,
    description TEXT NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    affected_systems TEXT[],
    violation_details JSONB,
    remediation_status VARCHAR(50) DEFAULT 'open',
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS security_alerts (
    alert_id VARCHAR(100) PRIMARY KEY,
    alert_type VARCHAR(50) NOT NULL,
    severity VARCHAR(20) NOT NULL,
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    affected_systems TEXT[],
    indicators JSONB,
    recommended_actions TEXT[],
    status VARCHAR(50) DEFAULT 'open',
    false_positive_probability DECIMAL(3,2) DEFAULT 0.0,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_security_events_timestamp ON security_events(timestamp);
CREATE INDEX IF NOT EXISTS idx_security_events_user ON security_events(user_id);
CREATE INDEX IF NOT EXISTS idx_compliance_violations_standard ON compliance_violations(standard);
CREATE INDEX IF NOT EXISTS idx_security_alerts_severity ON security_alerts(severity);

-- Insert sample data (optional)
INSERT INTO security_events (event_id, event_type, timestamp, action_attempted, success, risk_level, details)
VALUES ('init_001', 'system_event', NOW(), 'database_initialization', true, 'low', '{"setup": "automated"}')
ON CONFLICT (event_id) DO NOTHING;
EOF
}

run_health_checks() {
    log_info "Running health checks..."
    
    if [ "$SETUP_METHOD" = "docker" ]; then
        # Wait for services to be fully ready
        log_info "Waiting for services to be ready..."
        sleep 30
        
        # Check Docker services
        log_info "Checking Docker services..."
        SERVICES=("neo4j" "redis" "postgres" "milvus" "ltm-platform")
        
        for service in "${SERVICES[@]}"; do
            if docker-compose ps "$service" | grep -q "Up"; then
                log_success "$service is running"
            else
                log_warning "$service may not be running properly"
            fi
        done
        
        # Test HTTP endpoints
        check_endpoint() {
            local url=$1
            local service_name=$2
            local max_attempts=10
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
                if curl -s -f "$url" > /dev/null 2>&1; then
                    log_success "$service_name is responding at $url"
                    return 0
                fi
                log_info "Attempt $attempt/$max_attempts: Waiting for $service_name..."
                sleep 5
                ((attempt++))
            done
            
            log_warning "$service_name is not responding at $url"
            return 1
        }
        
        check_endpoint "http://localhost:8000/health" "LTM Platform"
        check_endpoint "http://localhost:8002/health" "API Gateway"
        check_endpoint "http://localhost:7474" "Neo4j Browser"
        check_endpoint "http://localhost:9090" "Prometheus"
        
    else
        # Native health check
        if [ -f "$VENV_DIR/bin/activate" ]; then
            source "$VENV_DIR/bin/activate"
        fi
        
        # Test Python imports
        if python -c "import ltm_integration, security, monitoring, api_gateway" 2>/dev/null; then
            log_success "Python modules imported successfully"
        else
            log_warning "Some Python modules may not be available"
        fi
    fi
}

print_post_setup_instructions() {
    log_success "LTM Network Intelligence Platform setup completed!"
    echo ""
    echo "================================================"
    echo "SETUP SUMMARY"
    echo "================================================"
    echo "Setup Method: $SETUP_METHOD"
    echo "Platform Directory: $LTM_PLATFORM_DIR"
    echo "Environment File: $ENV_FILE"
    echo ""
    
    if [ "$SETUP_METHOD" = "docker" ]; then
        echo "DOCKER SERVICES:"
        echo "  - LTM Platform: http://localhost:8000"
        echo "  - API Gateway: http://localhost:8002"
        echo "  - API Documentation: http://localhost:8002/api/docs"
        echo "  - Neo4j Browser: http://localhost:7474"
        echo "  - Prometheus: http://localhost:9090"
        echo "  - Grafana: http://localhost:3000"
        echo ""
        echo "DOCKER COMMANDS:"
        echo "  Start: ./start_platform_docker.sh"
        echo "  Stop:  docker-compose down"
        echo "  Logs:  docker-compose logs -f ltm-platform"
        echo "  Shell: docker-compose exec ltm-platform bash"
    else
        echo "NATIVE SETUP:"
        echo "  Virtual Environment: $VENV_DIR"
        echo "  Activate: source $VENV_DIR/bin/activate"
        echo "  Start: ./start_platform_native.sh"
        echo ""
        echo "MANUAL START:"
        echo "  cd $LTM_PLATFORM_DIR"
        echo "  source ltm-venv/bin/activate"
        echo "  python unified_network_intelligence.py"
    fi
    
    echo ""
    echo "IMPORTANT NEXT STEPS:"
    echo "1. Update API keys in $ENV_FILE"
    echo "2. Configure your network devices in config/devices_enhanced.json"
    echo "3. Review security settings in config/security_config.json"
    echo "4. Test the installation: curl http://localhost:8000/health"
    echo ""
    echo "INTEGRATION:"
    echo "  To integrate with existing repositories:"
    echo "  python scripts/setup_integration.py --interactive"
    echo ""
    echo "DOCUMENTATION:"
    echo "  - Quick Start Guide: docs/QUICK_START.md"
    echo "  - Integration Guide: docs/INTEGRATION_GUIDE.md"
    echo "  - Platform Documentation: http://localhost:8002/api/docs"
    echo ""
}

# Main execution
main() {
    echo "=========================================="
    echo "LTM Network Intelligence Platform"
    echo "Quick Setup Script v2.0.0"
    echo "=========================================="
    echo ""
    
    # Change to platform directory
    cd "$LTM_PLATFORM_DIR"
    
    # Check requirements
    check_requirements
    
    # Detect setup method
    detect_setup_method
    
    # Create environment file
    create_env_file
    
    # Create startup scripts
    create_startup_scripts
    
    # Create PostgreSQL initialization
    create_postgres_init
    
    # Run setup based on method
    if [ "$SETUP_METHOD" = "docker" ]; then
        setup_docker
    else
        setup_native
    fi
    
    # Run health checks
    run_health_checks
    
    # Print final instructions
    print_post_setup_instructions
}

# Handle script arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --docker)
            SETUP_METHOD="docker"
            shift
            ;;
        --native)
            SETUP_METHOD="native"
            shift
            ;;
        --no-health-check)
            SKIP_HEALTH_CHECK=true
            shift
            ;;
        --help)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --docker             Force Docker setup"
            echo "  --native             Force native Python setup"
            echo "  --no-health-check    Skip health checks"
            echo "  --help               Show this help message"
            echo ""
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Run main function
main